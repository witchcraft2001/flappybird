0001   0000                             device zxspectrum128
0002   0000                             include "include\head.asm"
0001+  0000             		org 8100h-512
0002+  7F00             start_addr: 
0003+  7F00             code_start: 
0004+  7F00             		; display "start_addr=",$
0005+  7F00             
0006+  7F00 45 58 45    		db "EXE"
0007+  7F03 00          		db 0
0008+  7F04 00 02       		dw 200h
0009+  7F06 00 00       		dw 0
0010+  7F08 00 00       		dw 0
0011+  7F0A 00 00       		dw 0
0012+  7F0C 00 00       		dw 0
0013+  7F0E 00 00       		dw 0
0014+  7F10 00 81       		dw begin
0015+  7F12 00 81       		dw begin
0016+  7F14 FF BF       		dw 0bfffh
0017+  7F16 00          		ds 490
0018+  8100             		
0019+  8100             ;		.PHASE 8100h
0020+  8100             		
0021+  8100             
0003   8100                             include "include\dss_equ.asm"
0001+  8100             DssRst		EQU	#10
0002+  8100             
0003+  8100             Dss.Version	EQU	#00
0004+  8100             Dss.ChDisk	EQU	#01
0005+  8100             Dss.CurDisk	EQU	#02
0006+  8100             Dss.DskInfo	EQU	#03
0007+  8100             ;Dss.G_ENTRY	EQU	#04
0008+  8100             ;		EQU	#05
0009+  8100             ;		EQU	#06
0010+  8100             ;		EQU	#07
0011+  8100             ;		EQU	#08
0012+  8100             Dss.BOOTDSK	EQU	#09
0013+  8100             ;File io
0014+  8100             Dss.Create	EQU	#0A
0015+  8100             Dss.Creat_N	EQU	#0B
0016+  8100             ;		EQU	#0C
0017+  8100             ;Dss.ERASE	EQU	#0D
0018+  8100             Dss.Delete	EQU	#0E
0019+  8100             ;Dss.Move	EQU	#0F
0020+  8100             Dss.Rename	EQU	#10
0021+  8100             Dss.Open	EQU	#11
0022+  8100             Dss.Close	EQU	#12
0023+  8100             Dss.Read	EQU	#13
0024+  8100             Dss.Write	EQU	#14
0025+  8100             Dss.Move_FP	EQU	#15
0026+  8100             Dss.Attrib	EQU	#16
0027+  8100             Dss.Get_D_T	EQU	#17
0028+  8100             Dss.Put_D_T	EQU	#18
0029+  8100             Dss.F_First	EQU	#19
0030+  8100             Dss.F_Next	EQU	#1A
0031+  8100             Dss.MkDir	EQU	#1B
0032+  8100             Dss.RmDir	EQU	#1C
0033+  8100             Dss.ChDir	EQU	#1D
0034+  8100             Dss.CurDir	EQU	#1E
0035+  8100             ;		EQU	#1F
0036+  8100             ;		EQU	#20
0037+  8100             Dss.SysTime	EQU	#21
0038+  8100             Dss.SetTime	EQU	#22
0039+  8100             ;		EQU	#23
0040+  8100             ;		EQU	#24
0041+  8100             ;		EQU	#25
0042+  8100             ;		EQU	#26
0043+  8100             ;		EQU	#27
0044+  8100             ;		EQU	#28
0045+  8100             ;		EQU	#29
0046+  8100             ;		EQU	#2A
0047+  8100             ;		EQU	#2B
0048+  8100             ;		EQU	#2C
0049+  8100             ;		EQU	#2D
0050+  8100             ;		EQU	#2E
0051+  8100             ;		EQU	#2F
0052+  8100             ;Keyboard
0053+  8100             Dss.WaitKey	EQU	#30
0054+  8100             Dss.ScanKey	EQU	#31
0055+  8100             Dss.EchoKey	EQU	#32
0056+  8100             Dss.CTRLKey	EQU	#33
0057+  8100             ;Dss.EDIT	EQU	#34
0058+  8100             Dss.K_CLEAR	EQU	#35
0059+  8100             Dss.K_SETUP	EQU	#36
0060+  8100             Dss.TESTKEY	EQU	#37
0061+  8100             ;Memory
0062+  8100             Dss.SetWin	EQU	#38
0063+  8100             Dss.SetWin1	EQU	#39
0064+  8100             Dss.SetWin2	EQU	#3A
0065+  8100             Dss.SetWin3	EQU	#3B
0066+  8100             Dss.INFOMEM	EQU	#3C
0067+  8100             Dss.GetMem	EQU	#3D
0068+  8100             Dss.FreeMem	EQU	#3E
0069+  8100             Dss.SetMem	EQU	#3F
0070+  8100             ;Execution
0071+  8100             Dss.Exec	EQU	#40
0072+  8100             Dss.Exit	EQU	#41
0073+  8100             Dss.Wait	EQU	#42
0074+  8100             
0075+  8100             Dss.GSwitch	EQU	#43
0076+  8100             Dss.DosName	EQU	#44
0077+  8100             Dss.EX_Path	EQU	#45
0078+  8100             Dss.Environ	EQU	#46
0079+  8100             Dss.AppInfo	EQU	#47
0080+  8100             ;		EQU	#48
0081+  8100             ;		EQU	#49
0082+  8100             ;		EQU	#4A
0083+  8100             ;		EQU	#4B
0084+  8100             ;		EQU	#4C
0085+  8100             ;		EQU	#4D
0086+  8100             ;		EQU	#4E
0087+  8100             ;		EQU	#4F
0088+  8100             
0089+  8100             Dss.SetVMod	EQU	#50
0090+  8100             Dss.GetVMod	EQU	#51
0091+  8100             Dss.Locate	EQU	#52
0092+  8100             Dss.Cursor	EQU	#53
0093+  8100             Dss.SelPage	EQU	#54
0094+  8100             Dss.Scroll	EQU	#55
0095+  8100             Dss.Clear	EQU	#56
0096+  8100             Dss.RdChar	EQU	#57
0097+  8100             Dss.WrChar	EQU	#58
0098+  8100             Dss.WinCopy	EQU	#59
0099+  8100             Dss.WinRest	EQU	#5A
0100+  8100             Dss.PutChar	EQU	#5B
0101+  8100             Dss.PChars	EQU	#5C
0102+  8100             ;Dss.RES_PRN	EQU	#5D
0103+  8100             ;Dss.CTRLPRN	EQU	#5E
0104+  8100             Dss.Print	EQU	#5F
0105+  8100             ;
0106+  8100             FileMode.RW:     EQU     #00
0107+  8100             FileMode.Read:   EQU     #01
0108+  8100             FileMode.Write:  EQU     #02
0109+  8100             FileAttrib.Normal equ   #00	; Normal file, no attributes 
0110+  8100             FileAttrib.RDOnly equ   #01	; Read only attribute 
0111+  8100             FileAttrib.Hidden equ   #02	; Hidden file 
0112+  8100             FileAttrib.System equ   #04	; System file 
0113+  8100             FileAttrib.Label  equ   #08	; Volume label
0114+  8100             FileAttrib.Direc  equ   #10	; Directory
0115+  8100             FileAttrib.Arch   equ   #20     ; Archive
0116+  8100             
0117+  8100             ;-------------------------
0118+  8100             ;characters
0119+  8100             cr		equ 0dh		;возврат коретки
0120+  8100             lf		equ 0ah		;новая строка
0121+  8100             tab		equ 9		;символ табуляции
0122+  8100             space		equ 20h		;символ пробела
0004   8100                             include "include\bios_equ.asm"
0001+  8100             BiosRst			EQU	#08
0002+  8100             
0003+  8100             ;Функции работы с памятью
0004+  8100             Bios.Emm_Fn0		EQU	#C0
0005+  8100             Bios.Emm_Fn1		EQU	#C1
0006+  8100             Bios.Emm_Fn2		EQU	#C2
0007+  8100             Bios.Emm_Fn3		EQU	#C3
0008+  8100             Bios.Emm_Fn4		EQU	#C4
0009+  8100             Bios.Emm_Fn5		EQU	#C5
0010+  8100             Bios.Emm_Fn6		EQU	#C6
0011+  8100             Bios.Emm_Fn7		EQU	#C7
0012+  8100             Bios.Emm_Fn8		EQU	#C8
0013+  8100             Bios.Emm_Fn9		EQU	#C9
0014+  8100             
0015+  8100             Bios.SetPalette         EQU     #A4		; установка палитры
0016+  8100             
0017+  8100             ;Функции управления окнами и режимами экрана
0018+  8100             Bios.Win_Open		EQU	#B0
0019+  8100             Bios.Win_Close		EQU	#B1
0020+  8100             Bios.Win_Copy_Win	EQU	#B2
0021+  8100             Bios.Win_Restore_Win	EQU	#B3
0022+  8100             Bios.Win_Get_Sym	EQU	#B4
0023+  8100             Bios.Win_Put_Sym	EQU	#B5
0024+  8100             Bios.Win_Set_ZG		EQU	#B6
0025+  8100             Bios.Win_Move_Win	EQU	#B7
0026+  8100             Bios.Win_Get_ZG		EQU	#B8
0027+  8100             
0028+  8100             
0029+  8100             
0030+  8100             ;Функции вывода текста на экран
0031+  8100             Bios.Lp_Print_All	EQU	#81
0032+  8100             Bios.Lp_Print_Sym	EQU	#82
0033+  8100             Bios.Lp_Print_Atr	EQU	#83
0034+  8100             Bios.Lp_Set_Place	EQU	#84
0035+  8100             Bios.Lp_Print_Ln	EQU	#85
0036+  8100             Bios.Lp_Print_Ln2	EQU	#86
0037+  8100             Bios.Lp_Print_Ln3	EQU	#87
0038+  8100             Bios.Lp_Print_Ln4	EQU	#88
0039+  8100             Bios.Lp_Cls_Win		EQU	#89
0040+  8100             Bios.Lp_Scroll_Up	EQU	#8A
0041+  8100             Bios.Lp_Print_Ln5	EQU	#8B
0042+  8100             Bios.Lp_Print_Ln6	EQU	#8C
0043+  8100             Bios.Lp_Cls_Win2	EQU	#8D
0044+  8100             Bios.Lp_Get_Place	EQU	#8E
0045+  8100             
0046+  8100             ;Функции работы с жесткими дисками и дисководами
0047+  8100             Bios.Drv_Reset		EQU	#51
0048+  8100             Bios.Drv_Verify		EQU	#54
0049+  8100             Bios.Drv_Read		EQU	#55
0050+  8100             Bios.Drv_Write		EQU	#56
0051+  8100             Bios.Drv_Detect		EQU	#57
0052+  8100             Bios.Drv_Get_Par	EQU	#58
0053+  8100             Bios.Drv_Set_Par	EQU	#59
0054+  8100             Bios.Ext_Version	EQU	#5A
0055+  8100             Bios.Drv_List		EQU	#5F
0056+  8100             
0057+  8100             
0058+  8100             
0059+  8100             
0060+  8100             
0061+  8100             
0005   8100                             include "include\sp_equ.asm"
0001+  8100             EmmWin.P0	EQU	#82
0002+  8100             EmmWin.P1	EQU	#A2
0003+  8100             EmmWin.P2	EQU	#C2
0004+  8100             EmmWin.P3	EQU	#E2
0005+  8100             Y_PORT          EQU     #89
0006+  8100             RGADR           EQU     Y_PORT
0007+  8100             RGMOD           EQU     #C9
0008+  8100             
0006   8100             
0007   8100 C3 03 81    begin: 		    jp main
0008   8103             
0009   8103 F3          main: 	        di
0010   8104             ;                ld (DOSLine+1),ix
0011   8104 CD 3E 83                    call SavePages
0012   8107 21 80 89                    ld hl,AppDir
0013   810A 01 47 01                    ld bc,256 + Dss.AppInfo
0014   810D D7                          rst #10
0015   810E 21 80 89                    ld hl,AppDir
0016   8111 11 00 8A                    ld de,AssetsDir
0017   8114 01 80 00                    ld bc,128
0018   8117 ED B0                       ldir
0019   8119 21 00 8A                    ld hl,AssetsDir
0020   811C E5                          push hl
0021   811D CD 38 83                    call FindNextName
0022   8120 2B                          dec hl
0023   8121 EB                          ex de,hl
0024   8122 21 99 84                    ld hl,AssetsDirName
0025   8125 01 07 00                    ld bc,city-AssetsDirName
0026   8128 ED B0                       ldir
0027   812A E1                          pop hl
0028   812B E5                          push hl
0029   812C 0E 1D                       ld c,Dss.ChDir
0030   812E D7                          rst #10
0031   812F 30 0A                       jr nc,.next
0032   8131 21 47 84                    ld hl,OpenDirErrorMessage
0033   8134 0E 5C                       ld c,Dss.PChars
0034   8136 D7                          rst #10
0035   8137 E1                          pop hl
0036   8138 C3 7C 83                    jp PrintError
0037   813B             
0038   813B E1          .next:           pop hl
0039   813C 21 69 84                    ld hl,ResourcesLoadingMessage
0040   813F 0E 5C                       ld c,Dss.PChars
0041   8141 D7                          rst #10
0042   8142 3A 98 84                    ld a,(assetsBlocks)
0043   8145 F5                          push af
0044   8146 47                          ld b,a
0045   8147 0E 3D                       ld c,Dss.GetMem
0046   8149 D7                          rst #10
0047   814A DA 6D 83                    jp c,NotEnoughtMemory
0048   814D 32 BB 84                    ld (MemoryDescriptor),a
0049   8150 21 94 84                    ld hl,MemoryBuffer
0050   8153 0E C5                       ld c,Bios.Emm_Fn5
0051   8155 CF                          rst #08
0052   8156 C1                          pop bc
0053   8157 11 94 84                    ld de,MemoryBuffer
0054   815A 21 A0 84                    ld hl,city
0055   815D D5          .loadLoop:       push de
0056   815E C5                          push bc
0057   815F E5                          push hl
0058   8160 CD EA 81                    call LoadResource
0059   8163 DA DE 81                    jp c,.error                
0060   8166 E1                          pop hl
0061   8167 CD 38 83                    call FindNextName
0062   816A C1                          pop bc
0063   816B D1                          pop de
0064   816C 13                          inc de
0065   816D 10 EE                       djnz .loadLoop                
0066   816F CD C6 84                    call ChangeVideoMode
0067   8172 21 F6 86                    ld hl,Palette+1
0068   8175 3A F5 86                    ld a,(Palette)
0069   8178 57                          ld d,a
0070   8179 1E 00                       ld e,0
0071   817B 3E 01                       ld a,1
0072   817D CD B5 85                    call SetPalette
0073   8180 21 F6 86                    ld hl,Palette+1
0074   8183 3A F5 86                    ld a,(Palette)
0075   8186 57                          ld d,a
0076   8187 1E 00                       ld e,0
0077   8189 3E 00                       ld a,0
0078   818B CD B5 85                    call SetPalette
0079   818E             
0080   818E                             ; ld hl,TempPal
0081   818E                             ; call ResetPallete
0082   818E                             ; call ShowBackground
0083   818E                             ; call CopyBackground
0084   818E 11 C3 83                    ld de,Im2Handler
0085   8191 CD D8 86                    call set_im2
0086   8194 CD 92 83                    call PlayerInit
0087   8197                             ; ld hl,Palette+1
0088   8197                             ; ld de,TempPal
0089   8197                             ; ld a,(Palette)
0090   8197                             ; ld b,a
0091   8197                             ; ld c,0
0092   8197                             ; call UnfadePallete
0093   8197 CD 15 82                    call FillScreen
0094   819A CD 5C 82                    call DrawCity
0095   819D CD C3 82                    call DrawWay
0096   81A0 DB C9                       in a,(RGMOD)
0097   81A2 EE 01                       xor 1
0098   81A4 D3 C9                       out (RGMOD),a
0099   81A6 CD 15 82                    call FillScreen
0100   81A9 CD 5C 82                    call DrawCity
0101   81AC CD C3 82                    call DrawWay
0102   81AF DB C9                       in a,(RGMOD)
0103   81B1 A7                          and a
0104   81B2 3E 01                       ld a,1
0105   81B4 20 03                       jr nz,.loop
0106   81B6 32 D7 83                    ld (Im2Handler.needChangePage),a        ;Переключаем основной экран на 1
0107   81B9 FB          .loop:           ei
0108   81BA 76                          halt
0109   81BB 3E 01                       ld a,1
0110   81BD 32 D7 83                    ld (Im2Handler.needChangePage),a
0111   81C0             
0112   81C0                             ; call Update0Screen
0113   81C0                             ; call UpdateScreenFlag
0114   81C0 CD C7 86                    call CheckKeys
0115   81C3 D2 B9 81                    jp nc,.loop
0116   81C6             
0117   81C6             .exit: 
0118   81C6 DB C9                       in a,(RGMOD)
0119   81C8 E6 01                       and 1                
0120   81CA C4 E8 84                    call nz,ChangeVideoPage
0121   81CD                             ; ld hl,Palette+1
0122   81CD                             ; ld de,TempPal
0123   81CD                             ; push de
0124   81CD                             ; ld bc,256*4
0125   81CD                             ; ldir
0126   81CD                             ; pop hl
0127   81CD                             ; ld a,(Palette)
0128   81CD                             ; ld d,a
0129   81CD                             ; ld e,0                
0130   81CD                             ; call FadePallete
0131   81CD CD AE 83                    call PlayerMute
0132   81D0 CD EC 86                    call set_im1
0133   81D3 CD DF 84                    call RestoreVideoMode
0134   81D6 CD 58 83                    call RestorePages
0135   81D9 01 41 00                    ld bc,Dss.Exit
0136   81DC D7          	        rst #10
0137   81DD C9          	        ret
0138   81DE             
0139   81DE E1          .error:          pop hl
0140   81DF D1                          pop de
0141   81E0 C1                          pop bc
0142   81E1 C3 73 83                    jp  FileReadError
0143   81E4             
0144   81E4             ;Обновляем флаг необходимости смены основного экрана
0145   81E4             UpdateScreenFlag: 
0146   81E4 3E 01                       ld a,1
0147   81E6 32 D7 83                    ld (Im2Handler.needChangePage),a
0148   81E9 C9                          ret
0149   81EA             
0150   81EA 1A          LoadResource:    ld  a,(de)
0151   81EB D3 E2                       out (EmmWin.P3),a
0152   81ED E5                          push hl
0153   81EE 0E 5C                       ld c,Dss.PChars
0154   81F0 D7                          rst #10
0155   81F1 21 8F 84                    ld hl,CrLf
0156   81F4 0E 5C                       ld c,Dss.PChars
0157   81F6 D7                          rst #10
0158   81F7 E1                          pop hl
0159   81F8 AF                          xor a
0160   81F9 0E 11       	        ld c,Dss.Open
0161   81FB D7          	        rst #10
0162   81FC D8          	        ret c
0163   81FD 32 93 84    	        ld (fHandler),A
0164   8200 21 00 C0                    LD	HL,ADDR
0165   8203 11 00 40    	        LD	DE,#4000
0166   8206 3A 93 84    	        LD	A,(fHandler)
0167   8209 0E 13       	        LD	C,Dss.Read
0168   820B D7          	        RST	#10
0169   820C F5                          push af
0170   820D 3A 93 84                    LD	A,(fHandler)
0171   8210 0E 12                       ld c,Dss.Close
0172   8212 D7                          rst #10
0173   8213 F1                          pop af
0174   8214 C9                          ret
0175   8215             
0176   8215 DB E2       FillScreen:      in a,(EmmWin.P3)
0177   8217 F5                          push af
0178   8218 3E 50                       ld a,#50
0179   821A D3 E2                       out (EmmWin.P3),a
0180   821C 01 40 01                    ld bc,320
0181   821F DB C9                       in a,(RGMOD)
0182   8221 21 00 C0                    ld hl,#c000
0183   8224 E6 01                       and 1
0184   8226 28 03                       jr z,.firstScreen
0185   8228 21 40 C1                    ld hl,#c140
0186   822B             .firstScreen:    
0187   822B 06 96                       ld b,150
0188   822D AF                          xor a
0189   822E D3 89       .loop1:          out (Y_PORT),a
0190   8230 36 00                       ld (hl),0
0191   8232 3C                          inc a
0192   8233 10 F9                       djnz .loop1
0193   8235 06 46                       ld b,70
0194   8237 D3 89       .loop2:          out (Y_PORT),a
0195   8239 36 01                       ld (hl),1
0196   823B 3C                          inc a
0197   823C 10 F9                       djnz .loop2
0198   823E 06 24                       ld b,36
0199   8240 D3 89       .loop3:          out (Y_PORT),a
0200   8242 36 02                       ld (hl),2
0201   8244 3C                          inc a
0202   8245 10 F9                       djnz .loop3
0203   8247             ;TODO: check on real this example                
0204   8247                             ; ld d,d
0205   8247                             ; ld a,100        ;sky height
0206   8247                             ; ld e,e
0207   8247                             ; ld (hl),0
0208   8247                             ; ld b,b
0209   8247                             ; ld a,99
0210   8247                             ; out (Y_PORT),a
0211   8247                             ; ld d,d
0212   8247                             ; ld a,100        ;grass height
0213   8247                             ; ld e,e
0214   8247                             ; ld (hl),1
0215   8247                             ; ld b,b
0216   8247             
0217   8247                             ; ld a,199        ;grass Y pos
0218   8247                             ; out (Y_PORT),a
0219   8247                             ; ld d,d
0220   8247                             ; ld a,56         ;wall height
0221   8247                             ; ld e,e
0222   8247                             ; ld (hl),2
0223   8247                             ; ld b,b
0224   8247 F3                          di
0225   8248 AF                          xor a
0226   8249 D3 89                       out (Y_PORT),a
0227   824B 54                          ld d,h
0228   824C 5D                          ld e,l
0229   824D 13                          inc de
0230   824E 01 3F 01                    ld bc,#140-1
0231   8251 52                          ld d,d         ;copy vertical lines
0232   8252 3E 00                       ld a,0
0233   8254 7F                          ld a,a
0234   8255 ED B0                       ldir
0235   8257 40                          ld b,b
0236   8258 F1                          pop af
0237   8259 D3 E2                       out (EmmWin.P3),a
0238   825B C9                          ret
0239   825C             
0240   825C             DrawCity:        
0241   825C DB A2                       IN A,(EmmWin.P1)
0242   825E F5                          push af
0243   825F DB E2                       IN A,(EmmWin.P3)
0244   8261 F5                          push af
0245   8262 3E 50                       LD A,#50
0246   8264 D3 A2                       OUT (EmmWin.P1),A
0247   8266 3A 94 84                    ld a,(MemoryBuffer.memCity)
0248   8269 D3 E2                       out (EmmWin.P3),a
0249   826B 21 00 40                    ld hl,#4000
0250   826E DB C9                       in a,(RGMOD)
0251   8270 E6 01                       and 1
0252   8272 20 03                       jr nz,.firstpg
0253   8274 21 40 41                    ld hl,#4140
0254   8277 11 8A 00    .firstpg:        ld de,138
0255   827A 22 98 82                    ld (.adr1),hl
0256   827D 19                          add hl,de
0257   827E 22 A2 82                    ld (.adr2),hl
0258   8281 19                          add hl,de
0259   8282 22 A9 82                    ld (.adr3),hl
0260   8285 21 00 C0                    ld hl,#c000     ;city sprite
0261   8288 3E 00                       ld a,0
0262   828A             .pos:            equ $-1
0263   828A 4F                          ld c,a
0264   828B 06 00                       ld b,0
0265   828D 09                          add hl,bc
0266   828E 06 27                       ld b,39         ;city hgt
0267   8290 3E 96                       ld a,150        ;city Y pos
0268   8292 C5          .loop: 	        PUSH BC
0269   8293 F5                          push af
0270   8294 D3 89                       OUT (#89),A
0271   8296 F3                          di
0272   8297 11 00 00                    ld de,0
0273   829A             .adr1:           equ $-2                
0274   829A 52                          ld d,d		;enable accel, set buffer size
0275   829B 3E 8A                       ld a,138        ;pattern lenght
0276   829D 6D                          ld l,l
0277   829E 7E                          ld a,(hl)
0278   829F 12                          ld (de),a
0279   82A0 40                          ld b,b
0280   82A1             
0281   82A1 11 00 00                    ld de,0
0282   82A4             .adr2:           equ $-2
0283   82A4 6D                          ld l,l
0284   82A5 7E                          ld a,(hl)
0285   82A6 12                          ld (de),a
0286   82A7 40                          ld b,b
0287   82A8             
0288   82A8 11 00 00                    ld de,0
0289   82AB             .adr3:           equ $-2
0290   82AB 52                          ld d,d
0291   82AC 3E 2C                       ld a,44
0292   82AE 6D                          ld l,l
0293   82AF 7E                          ld a,(hl)
0294   82B0 12                          ld (de),a
0295   82B1 40                          ld b,b
0296   82B2 FB                          ei
0297   82B3 01 14 01                    ld bc,276
0298   82B6 09                          add hl,bc
0299   82B7 F1                          pop af
0300   82B8 C1                          POP BC
0301   82B9 3C                          INC A
0302   82BA 10 D6                       DJNZ .loop
0303   82BC F1                          pop af
0304   82BD D3 E2                       OUT (EmmWin.P3),A
0305   82BF F1                          pop af
0306   82C0 D3 A2                       OUT (EmmWin.P1),A
0307   82C2 C9                          RET
0308   82C3             
0309   82C3             DrawWay: 
0310   82C3 DB A2                       IN A,(EmmWin.P1)
0311   82C5 F5                          push af
0312   82C6 DB E2                       IN A,(EmmWin.P3)
0313   82C8 F5                          push af
0314   82C9 3E 50                       LD A,#50
0315   82CB D3 A2                       OUT (EmmWin.P1),A
0316   82CD 3A 95 84                    ld a,(MemoryBuffer.memWay)
0317   82D0 D3 E2                       out (EmmWin.P3),a
0318   82D2 21 00 40                    ld hl,#4000
0319   82D5 DB C9                       in a,(RGMOD)
0320   82D7 E6 01                       and 1
0321   82D9 20 03                       jr nz,.firstpg
0322   82DB 21 40 41                    ld hl,#4140
0323   82DE             .firstpg:        
0324   82DE 11 84 00                    ld de,132
0325   82E1 22 FF 82                    ld (.adr1),hl
0326   82E4 19                          add hl,de
0327   82E5 22 09 83                    ld (.adr2),hl
0328   82E8 19                          add hl,de
0329   82E9 22 10 83                    ld (.adr3),hl
0330   82EC 21 00 C0                    ld hl,#c000     ;city sprite
0331   82EF 3E 00                       ld a,0
0332   82F1             .pos:            equ $-1
0333   82F1 4F                          ld c,a
0334   82F2 06 00                       ld b,0
0335   82F4 09                          add hl,bc
0336   82F5 06 0B                       ld b,11        ;way hgt
0337   82F7 3E DC                       ld a,220        ;way Y pos
0338   82F9 C5          .loop: 	        PUSH BC
0339   82FA F5                          push af
0340   82FB D3 89                       OUT (#89),A
0341   82FD F3                          di
0342   82FE 11 00 00                    ld de,0
0343   8301             .adr1:           equ $-2                
0344   8301 52                          ld d,d		;enable accel, set buffer size
0345   8302 3E 84                       ld a,132        ;pattern lenght
0346   8304 6D                          ld l,l
0347   8305 7E                          ld a,(hl)
0348   8306 12                          ld (de),a
0349   8307 40                          ld b,b
0350   8308             
0351   8308 11 00 00                    ld de,0
0352   830B             .adr2:           equ $-2
0353   830B 6D                          ld l,l
0354   830C 7E                          ld a,(hl)
0355   830D 12                          ld (de),a
0356   830E 40                          ld b,b
0357   830F             
0358   830F 11 00 00                    ld de,0
0359   8312             .adr3:           equ $-2
0360   8312 52                          ld d,d
0361   8313 3E 38                       ld a,56
0362   8315 6D                          ld l,l
0363   8316 7E                          ld a,(hl)
0364   8317 12                          ld (de),a
0365   8318 40                          ld b,b
0366   8319 FB                          ei
0367   831A 01 8C 00                    ld bc,140
0368   831D 09                          add hl,bc
0369   831E F1                          pop af
0370   831F C1                          POP BC
0371   8320 3C                          INC A
0372   8321 10 D6                       DJNZ .loop
0373   8323 F1                          pop af
0374   8324 D3 E2                       OUT (EmmWin.P3),A
0375   8326 F1                          pop af
0376   8327 D3 A2                       OUT (EmmWin.P1),A
0377   8329 C9                          RET
0378   832A             
0379   832A D5          CoordToAddrP3:   push de
0380   832B 11 00 C0                    ld de,#c000
0381   832E 19                          add hl,de
0382   832F D1                          pop de
0383   8330 C9                          ret
0384   8331             
0385   8331 D5          CoordToAddrP1:   push de
0386   8332 11 00 40                    ld de,#4000
0387   8335 19                          add hl,de
0388   8336 D1                          pop de
0389   8337 C9                          ret
0390   8338             
0391   8338 7E          FindNextName:    ld a,(hl)
0392   8339 23                          inc hl
0393   833A A7                          and a
0394   833B C8                          ret z
0395   833C 18 FA                       jr FindNextName
0396   833E             
0397   833E             ;Сохранение номеров страниц при запуске
0398   833E 21 BC 84    SavePages:       ld hl,Pages
0399   8341 3E 82                       ld a,EmmWin.P0
0400   8343 CD D0 86                    call SavePage
0401   8346 23                          inc hl
0402   8347 3E A2                       ld a,EmmWin.P1
0403   8349 CD D0 86                    call SavePage
0404   834C 23                          inc hl
0405   834D 3E C2                       ld a,EmmWin.P2
0406   834F CD D0 86                    call SavePage
0407   8352 23                          inc hl
0408   8353 3E E2                       ld a,EmmWin.P3
0409   8355 C3 D0 86                    jp SavePage
0410   8358             
0411   8358             ;Восстановление номеров страниц при завершении
0412   8358             RestorePages: 
0413   8358 21 BC 84                    ld hl, Pages
0414   835B 3E 82                       ld a,EmmWin.P0
0415   835D CD D4 86                    call RestorePage
0416   8360 23                          inc hl
0417   8361 3E A2                       ld a,EmmWin.P1
0418   8363 CD D4 86                    call RestorePage
0419   8366 23                          inc hl
0420   8367                         ;ld a,cpu_w2
0421   8367                         ;call SavePage
0422   8367 23                          inc hl
0423   8368 3E E2                       ld a,EmmWin.P3
0424   836A C3 D4 86                    jp RestorePage
0425   836D             
0426   836D             NotEnoughtMemory: 	
0427   836D 21 08 84                    ld hl,NotEnoughtMemoryMessage
0428   8370 C3 7C 83        	        jp PrintError
0429   8373             
0430   8373             FileReadError: 
0431   8373 CD 58 83                    call RestorePages
0432   8376 21 29 84                    ld hl,FileReadErrorMessage
0433   8379 C3 7C 83                    jp PrintError
0434   837C             
0435   837C             PrintError: 	    
0436   837C 0E 5C                       ld c,Dss.PChars			;печатаем
0437   837E D7                          rst #10
0438   837F CD 58 83                    call RestorePages
0439   8382 3A BB 84                    ld a,(MemoryDescriptor)
0440   8385 A7                          and a
0441   8386 28 03                       jr z,.next
0442   8388 0E 3E                       ld c,Dss.FreeMem
0443   838A D7                          rst #10
0444   838B 01 41 FF    .next:           ld bc,#FF41
0445   838E D7                          rst #10
0446   838F C3 8F 83                    jp $				; привычка...
0447   8392             
0448   8392             PlayerInit: 
0449   8392 DB E2                       in a,(EmmWin.P3)
0450   8394 F5                          push af
0451   8395 3E 01                       ld a,1
0452   8397 32 EA 83                    ld (Im2Handler.musicEnabled),a
0453   839A 3A 96 84                    ld a,(MemoryBuffer.memMusic)
0454   839D D3 E2                       out (EmmWin.P3),a
0455   839F CD 00 C0                    call PlayerStart
0456   83A2 F1          .exit:           pop af
0457   83A3 D3 E2                       out (EmmWin.P3),a
0458   83A5 C9                          ret
0459   83A6             
0460   83A6 3A 96 84    Player:          ld a,(MemoryBuffer.memMusic)
0461   83A9 D3 E2                       out (EmmWin.P3),a
0462   83AB C3 05 C0                    jp PlayerStart+5
0463   83AE             PlayerMute: 
0464   83AE DB E2                       in a,(EmmWin.P3)
0465   83B0 F5                          push af
0466   83B1 3A EA 83                    ld a,(Im2Handler.musicEnabled)
0467   83B4 EE 01                       xor 1
0468   83B6 32 EA 83                    ld (Im2Handler.musicEnabled),a
0469   83B9 3A 96 84                    ld a,(MemoryBuffer.memMusic)
0470   83BC D3 E2                       out (EmmWin.P3),a
0471   83BE CD 08 C0                    call PlayerStart+8
0472   83C1 18 DF                       jr PlayerInit.exit
0473   83C3             
0474   83C3 F3          Im2Handler:      di
0475   83C4 F5                          push af
0476   83C5 E5                          push hl
0477   83C6 C5                          push bc
0478   83C7 D5                          push de
0479   83C8 DD E5                       push ix
0480   83CA FD E5                       push iy
0481   83CC D9                          exx
0482   83CD 08                          ex af,af'
0483   83CE F5                          push af
0484   83CF E5                          push hl
0485   83D0 C5                          push bc
0486   83D1 D5                          push de
0487   83D2 DD E5                       push ix
0488   83D4 FD E5                       push iy
0489   83D6 3E 00       	        ld a,0
0490   83D8             .needChangePage:  equ $-1
0491   83D8 A7          	        and a
0492   83D9 28 07       	        jr z,.skip
0493   83DB CD E8 84                    call ChangeVideoPage
0494   83DE AF                          xor a
0495   83DF 32 D7 83                    ld (.needChangePage),a
0496   83E2 DB E2       .skip:           in a,(EmmWin.P3)
0497   83E4 F5                          push af
0498   83E5 21 92 84                    ld hl,Counter
0499   83E8 34                          inc (hl)
0500   83E9 3E 00                       ld a,0
0501   83EB             .musicEnabled:   equ $-1
0502   83EB A7                          and a
0503   83EC C4 A6 83                    call nz,Player
0504   83EF F1                          pop af
0505   83F0 D3 E2                       out (EmmWin.P3),a
0506   83F2 FD E1                       pop iy
0507   83F4 DD E1                       pop ix
0508   83F6 D1                          pop de
0509   83F7 C1                          pop bc
0510   83F8 E1                          pop hl
0511   83F9 F1                          pop af
0512   83FA 08                          ex af,af'
0513   83FB D9                          exx
0514   83FC FD E1                       pop iy
0515   83FE DD E1                       pop ix
0516   8400 D1                          pop de
0517   8401 C1                          pop bc
0518   8402 E1                          pop hl
0519   8403 F1                          pop af
0520   8404 FB                          ei
0521   8405 C3 38 00                    jp #38
0522   8408             
0523   8408             NotEnoughtMemoryMessage: 
0524   8408                             db cr,lf,"Error: Not enought memory!",cr,lf
0524   8408 0D0A4572726F723A204E6F7420656E6F75676874206D656D6F7279210D0A
0525   8426 0D 0A 00    		db cr,lf,0
0526   8429             
0527   8429             FileReadErrorMessage: 
0528   8429                             db cr,lf,"Error: Can't read file!",cr,lf
0528   8429 0D0A4572726F723A2043616E277420726561642066696C65210D0A
0529   8444 0D 0A 00    		db cr,lf,0
0530   8447             OpenDirErrorMessage: 
0531   8447                             db cr,lf,"Error: Can't open ASSETS dir!"
0531   8447 0D0A4572726F723A2043616E2774206F70656E204153534554532064697221
0532   8466 0D 0A 00    		db cr,lf,0
0533   8469             
0534   8469             ResourcesLoadingMessage: 
0535   8469                             db cr,lf,"Loading resources, please wait ...",cr,lf
0535   8469 0D0A4C6F6164696E67207265736F75726365732C20706C656173652077616974
0535   8489 202E2E2E0D0A
0536   848F 0D 0A 00    CrLf: 		db cr,lf,0
0537   8492             
0538   8492 00          Counter:         db 0
0539   8493 00          fHandler        db 0
0540   8494             
0541   8494             MemoryBuffer: 
0542   8494 00          .memCity      db 0
0543   8495 00          .memWay       db 0
0544   8496 00          .memMusic       db 0
0545   8497 00                          db 0
0546   8498 03          assetsBlocks    db 3
0547   8499             
0548   8499             AssetsDirName   db "ASSETS",0
0548   8499 41535345545300
0549   84A0             city            db "city.bin",0
0549   84A0 636974792E62696E00
0550   84A9             way             db "way.bin",0
0550   84A9 7761792E62696E00
0551   84B1             music           db "music.bin",0
0551   84B1 6D757369632E62696E00
0552   84BB             MemoryDescriptor: 
0553   84BB 00                          db 0
0554   84BC             
0555   84BC             ;Страницы, которые были открыты при запуске программы
0556   84BC             Pages: 
0557   84BC 00          Page0:           db 0
0558   84BD 00          Page1:           db 0
0559   84BE 00          Page2:           db 0
0560   84BF 00          Page3:           db 0
0561   84C0             
0562   84C0             CardCoord0:       
0563   84C0 00          .y:              db 0
0564   84C1 00 00       .x:              dw 0
0565   84C3             
0566   84C3             CardCoord1: 
0567   84C3 00          .y:              db 0
0568   84C4 00 00       .x:              dw 0
0569   84C6             
0570   84C6                             include "grx_utils.asm"
0001+  84C6             ChangeVideoMode: 
0002+  84C6 0E 51       	LD	C,Dss.GetVMod
0003+  84C8 D7          	RST	#10
0004+  84C9 32 B7 86    	LD	(OldVideoMode),a
0005+  84CC 78          	ld	a,b
0006+  84CD 32 B8 86    	ld	(OldVideoPage),a
0007+  84D0 3E 81       	LD	A,#81
0008+  84D2 06 01       	LD	B,1
0009+  84D4 CD DB 84    	call	SetVideoMode
0010+  84D7 3E 81       	LD	A,#81
0011+  84D9 06 00       	LD	B,0
0012+  84DB             
0013+  84DB             SetVideoMode: 
0014+  84DB 0E 50       	LD	C,Dss.SetVMod
0015+  84DD D7          	RST	#10
0016+  84DE C9          	RET
0017+  84DF             RestoreVideoMode: 
0018+  84DF 3A B8 86    	ld	a,(OldVideoPage)
0019+  84E2 47          	LD	B,a
0020+  84E3 3A B7 86    	LD	a,(OldVideoMode)
0021+  84E6 18 F3       	JR	SetVideoMode
0022+  84E8             
0023+  84E8             ChangeVideoPage: 
0024+  84E8 DB C9       	in	a,(RGMOD)
0025+  84EA EE 01       	xor	1
0026+  84EC D3 C9       	out	(RGMOD),a
0027+  84EE C9          	ret
0028+  84EF             
0029+  84EF             ;BC - откуда
0030+  84EF             ;HL - ширина
0031+  84EF             ;DE - куда
0032+  84EF             ;A - Y координата
0033+  84EF             ;A' - Высота
0034+  84EF             
0035+  84EF             ShowBitmap: 
0036+  84EF 22 11 85    	LD	(.len), HL
0037+  84F2 60          	LD	H,B
0038+  84F3 69          	LD	L,C
0039+  84F4             ;	LD	HL,ADDR+#76
0040+  84F4             ;	LD	DE,#4000
0041+  84F4 08          	EX	AF,AF'
0042+  84F5 47          	LD	B,A
0043+  84F6 DB A2       	IN	A,(EmmWin.P1)
0044+  84F8 F5          	PUSH	AF
0045+  84F9 3E 50       	LD	A,#50
0046+  84FB D3 A2       	OUT	(EmmWin.P1),A
0047+  84FD DB C9       	in a,(RGMOD)
0048+  84FF E6 01       	and 1
0049+  8501 28 08       	jr z,.firstpg
0050+  8503 EB          	ex de,hl
0051+  8504 D5          	push de
0052+  8505 11 40 01    	ld de,#0140
0053+  8508 19          	add hl,de
0054+  8509 D1          	pop de
0055+  850A EB          	ex de,hl
0056+  850B             .firstpg: 
0057+  850B 08          	EX	AF,AF'
0058+  850C             ;	LD	A,0
0059+  850C             ;	LD	B,100
0060+  850C C5          .loop	PUSH	BC
0061+  850D D5          	PUSH	DE
0062+  850E D3 89       	OUT	(#89),A
0063+  8510 01 00 00    	LD	BC,0
0064+  8513             .len: 	EQU	$-2
0065+  8513 ED B0       	LDIR
0066+  8515 D1          	POP	DE
0067+  8516 C1          	POP	BC
0068+  8517 3C          	INC	A
0069+  8518 10 F2       	DJNZ	.loop
0070+  851A F1          	POP	AF
0071+  851B D3 A2       	OUT	(EmmWin.P1),A
0072+  851D C9          	RET
0073+  851E             
0074+  851E             ;BC - откуда
0075+  851E             ;HL - ширина
0076+  851E             ;DE - куда
0077+  851E             ;A - Y координата
0078+  851E             ;A' - Высота
0079+  851E             
0080+  851E             ShowBitmapShadow: 
0081+  851E 22 40 85    	LD	(.len), HL
0082+  8521 60          	LD	H,B
0083+  8522 69          	LD	L,C
0084+  8523             ;	LD	HL,ADDR+#76
0085+  8523             ;	LD	DE,#4000
0086+  8523 08          	EX	AF,AF'
0087+  8524 47          	LD	B,A
0088+  8525 DB A2       	IN	A,(EmmWin.P1)
0089+  8527 F5          	PUSH	AF
0090+  8528 3E 50       	LD	A,#50
0091+  852A D3 A2       	OUT	(EmmWin.P1),A
0092+  852C DB C9       	in a,(RGMOD)
0093+  852E E6 01       	and 1
0094+  8530 20 08       	jr nz,.firstpg
0095+  8532 EB          	ex de,hl
0096+  8533 D5          	push de
0097+  8534 11 40 01    	ld de,#0140
0098+  8537 19          	add hl,de
0099+  8538 D1          	pop de
0100+  8539 EB          	ex de,hl
0101+  853A             .firstpg: 
0102+  853A 08          	EX	AF,AF'
0103+  853B             ;	LD	A,0
0104+  853B             ;	LD	B,100
0105+  853B C5          .loop	PUSH	BC
0106+  853C D5          	PUSH	DE
0107+  853D D3 89       	OUT	(#89),A
0108+  853F 01 00 00    	LD	BC,0
0109+  8542             .len: 	EQU	$-2
0110+  8542 ED B0       	LDIR
0111+  8544 D1          	POP	DE
0112+  8545 C1          	POP	BC
0113+  8546 3C          	INC	A
0114+  8547 10 F2       	DJNZ	.loop
0115+  8549 F1          	POP	AF
0116+  854A D3 A2       	OUT	(EmmWin.P1),A
0117+  854C C9          	RET
0118+  854D             ;BC - высота/ширина
0119+  854D             ;HL - откуда
0120+  854D             ;DE - куда
0121+  854D             ;A - Y координата
0122+  854D             ShowBitmapAcc: 
0123+  854D             ;	LD	HL,ADDR+#76
0124+  854D             ;	LD	DE,#4000
0125+  854D 08          	ex af,af'
0126+  854E 79          	ld a,c
0127+  854F 32 6F 85    	ld (.len),a
0128+  8552 DB A2       	IN A,(EmmWin.P1)
0129+  8554 F5          	push af
0130+  8555 3E 50       	LD A,#50
0131+  8557 D3 A2       	OUT (EmmWin.P1),A
0132+  8559 DB C9       	in a,(RGMOD)
0133+  855B E6 01       	and 1
0134+  855D 20 08       	jr nz,.firstpg
0135+  855F EB          	ex de,hl
0136+  8560 D5          	push de
0137+  8561 11 40 01    	ld de,#0140
0138+  8564 19          	add hl,de
0139+  8565 D1          	pop de
0140+  8566 EB          	ex de,hl
0141+  8567             .firstpg: 
0142+  8567 08          	ex af,af'
0143+  8568             ;	LD	A,0
0144+  8568             ;	LD	B,100
0145+  8568 C5          .loop: 	PUSH BC
0146+  8569 F5          	push af
0147+  856A D3 89       	OUT (#89),A
0148+  856C F3          	di
0149+  856D 52          	ld d,d		;enable accel, set buffer size
0150+  856E 3E 00       	ld a,0
0151+  8570             .len: 	equ $-1
0152+  8570 6D          	ld l,l
0153+  8571 7E          	ld a,(hl)
0154+  8572 12          	ld (de),a
0155+  8573 40          	ld b,b
0156+  8574 FB          	ei
0157+  8575 06 00       	ld b,0
0158+  8577 09          	add hl,bc
0159+  8578 F1          	pop af
0160+  8579 C1          	POP BC
0161+  857A 3C          	INC A
0162+  857B 10 EB       	DJNZ .loop
0163+  857D F1          	pop af
0164+  857E D3 A2       	OUT (EmmWin.P1),A
0165+  8580 C9          	RET
0166+  8581             
0167+  8581             ;BC - высота/ширина
0168+  8581             ;HL - откуда
0169+  8581             ;DE - куда
0170+  8581             ;A - Y координата
0171+  8581             ShowMaskBitmapShadowAcc: 
0172+  8581             ;	LD	HL,ADDR+#76
0173+  8581             ;	LD	DE,#4000
0174+  8581 08          	ex af,af'
0175+  8582 79          	ld a,c
0176+  8583 32 A3 85    	ld (.len),a
0177+  8586 DB A2       	IN A,(EmmWin.P1)
0178+  8588 F5          	push af
0179+  8589 3E 5C       	LD A,#5C
0180+  858B D3 A2       	OUT (EmmWin.P1),A
0181+  858D DB C9       	in a,(RGMOD)
0182+  858F E6 01       	and 1
0183+  8591 20 08       	jr nz,.firstpg
0184+  8593 EB          	ex de,hl
0185+  8594 D5          	push de
0186+  8595 11 40 01    	ld de,#0140
0187+  8598 19          	add hl,de
0188+  8599 D1          	pop de
0189+  859A EB          	ex de,hl
0190+  859B             .firstpg: 
0191+  859B 08          	ex af,af'
0192+  859C             ;	LD	A,0
0193+  859C             ;	LD	B,100
0194+  859C C5          .loop	PUSH BC
0195+  859D F5          	push af
0196+  859E D3 89       	OUT (#89),A
0197+  85A0 F3          	di
0198+  85A1 52          	ld d,d		;enable accel, set buffer size
0199+  85A2 3E 00       	ld a,0
0200+  85A4             .len: 	equ $-1
0201+  85A4 6D          	ld l,l
0202+  85A5 7E          	ld a,(hl)
0203+  85A6 12          	ld (de),a
0204+  85A7 40          	ld b,b
0205+  85A8 FB          	ei
0206+  85A9 06 00       	ld b,0
0207+  85AB 09          	add hl,bc
0208+  85AC F1          	pop af
0209+  85AD C1          	POP BC
0210+  85AE 3C          	INC A
0211+  85AF 10 EB       	DJNZ .loop
0212+  85B1 F1          	pop af
0213+  85B2 D3 A2       	OUT (EmmWin.P1),A
0214+  85B4 C9          	RET
0215+  85B5             
0216+  85B5             ;HL - Palette
0217+  85B5             ;D - Colors count
0218+  85B5             ;E - Start color number
0219+  85B5             ;A - Palette number
0220+  85B5             SetPalette: 
0221+  85B5 F3          	di
0222+  85B6 E5          	push	hl
0223+  85B7 D5          	push	de
0224+  85B8 C5          	push	bc	
0225+  85B9 06 FF       	LD	B,0xff
0226+  85BB 0E A4       	LD	C,Bios.SetPalette
0227+  85BD CF          	RST	0x08
0228+  85BE C1          	pop	bc
0229+  85BF D1          	pop	de
0230+  85C0 E1          	pop	hl
0231+  85C1 FB          	ei
0232+  85C2 C9          	RET
0233+  85C3             
0234+  85C3             ;Копирует весь основ экран в теневой
0235+  85C3             CopyBackground: 	
0236+  85C3 F3                  di
0237+  85C4 DB E2               IN A,(EmmWin.P3)
0238+  85C6 F5          	PUSH AF
0239+  85C7 3E 50       	LD A,#50
0240+  85C9 D3 E2       	OUT (EmmWin.P3),A
0241+  85CB 21 00 C0    	ld hl,#c000
0242+  85CE 11 40 C1            ld de,#c140
0243+  85D1 01 40 01            ld bc,#140
0244+  85D4 52                  ld d,d
0245+  85D5 3E 00               ld a,0
0246+  85D7 7F          .loop:   ld a,a
0247+  85D8 7E                  ld a,(hl)
0248+  85D9 12          	ld (de),a
0249+  85DA 40                  ld b,b
0250+  85DB 23          	inc hl
0251+  85DC 13          	inc de
0252+  85DD 0B          	dec bc
0253+  85DE 78          	ld a,b
0254+  85DF B1          	or c
0255+  85E0 20 F5       	jr nz,.loop
0256+  85E2 F1          	pop af
0257+  85E3 D3 E2       	OUT (EmmWin.P3),A
0258+  85E5 FB                  ei
0259+  85E6 C9                  ret
0260+  85E7             ;Восстанавливает из основного ОЗУ в Видео ОЗУ прямоугольник (при использовании режима записи только в VRAM bit 2)
0261+  85E7             ;HL - Addr
0262+  85E7             ;B - Len
0263+  85E7             ;C - Height
0264+  85E7             ;A - Y
0265+  85E7             RestoreRect: 
0266+  85E7 08          	ex af,af'
0267+  85E8 DB E2       	IN A,(EmmWin.P3)
0268+  85EA F5          	push af
0269+  85EB 3E 50       	LD A,#50
0270+  85ED D3 E2       	OUT (EmmWin.P3),A
0271+  85EF DB C9       	in a,(RGMOD)
0272+  85F1 E6 01       	and 1
0273+  85F3 20 04       	jr nz,.firstpg
0274+  85F5 11 40 01    	ld de,#0140
0275+  85F8 19          	add hl,de
0276+  85F9             .firstpg: 
0277+  85F9 79          	ld a,c
0278+  85FA 32 04 86    	ld (.hgt),a
0279+  85FD F3          	di
0280+  85FE 08          	ex af,af'
0281+  85FF             .loop: 	
0282+  85FF D3 89       	out (Y_PORT),a
0283+  8601 3C          	inc a
0284+  8602 52          	ld d,d
0285+  8603 0E 00       	ld c,0
0286+  8605             .hgt: 	equ $-1
0287+  8605 6D          	ld l,l
0288+  8606 4E          	ld c,(hl)
0289+  8607 71          	ld (hl),c
0290+  8608 40          	ld b,b
0291+  8609 10 F4       	djnz .loop
0292+  860B F1          	pop af
0293+  860C D3 E2       	out (EmmWin.P3),a
0294+  860E FB          	ei
0295+  860F C9          	ret	
0296+  8610             
0297+  8610             
0298+  8610             ;Восстанавливает из теневого экрана прямоугольник
0299+  8610             ;HL - Addr
0300+  8610             ;B - Len
0301+  8610             ;C - Height
0302+  8610             ;A - Y
0303+  8610             RestoreBackground: 
0304+  8610 08          	ex af,af'
0305+  8611 DB E2       	IN A,(EmmWin.P3)
0306+  8613 F5          	push af
0307+  8614 3E 50       	LD A,#50
0308+  8616 D3 E2       	OUT (EmmWin.P3),A
0309+  8618 79          	ld a,c
0310+  8619 32 29 86    	ld (.hgt),a	
0311+  861C E5          	push hl
0312+  861D 11 40 01    	ld de,#140
0313+  8620 19          	add hl,de
0314+  8621 D1          	pop de
0315+  8622 F3          	di
0316+  8623 08          .loop: 	ex af,af'
0317+  8624 D3 89       	out (Y_PORT),a
0318+  8626 08          	ex af,af'
0319+  8627 52          	ld d,d
0320+  8628 3E 00       	ld a,0
0321+  862A             .hgt: 	equ $-1
0322+  862A 7F          	ld a,a
0323+  862B 7E          	ld a,(hl)
0324+  862C 12          	ld (de),a
0325+  862D 40          	ld b,b
0326+  862E 23          	inc hl
0327+  862F 13          	inc de
0328+  8630 10 F1       	djnz .loop
0329+  8632 F1          	pop af
0330+  8633 D3 E2       	out (EmmWin.P3),a
0331+  8635 FB          	ei
0332+  8636 C9          	ret
0333+  8637             
0334+  8637             ;HL - buffer
0335+  8637             ResetPallete: 
0336+  8637 E5          	push hl
0337+  8638 AF          	xor a
0338+  8639 06 FF       	ld b,255
0339+  863B 0E 04       .cls1: 	ld c,4
0340+  863D 77          .cls: 	ld (hl),a
0341+  863E 23          	inc hl
0342+  863F 0D          	dec c
0343+  8640 20 FB       	jr nz,.cls
0344+  8642 10 F7       	djnz .cls1
0345+  8644 E1          	pop hl
0346+  8645 11 00 FF    	ld de,#ff00
0347+  8648 AF          	xor a
0348+  8649 CD B5 85    	call SetPalette
0349+  864C C9          	ret
0350+  864D             
0351+  864D             ;HL - current pallette
0352+  864D             ;DE - buffer
0353+  864D             ;B - Colors count
0354+  864D             ;C - Start color number
0355+  864D             UnfadePallete: 
0356+  864D FB          	ei
0357+  864E E5          	push hl
0358+  864F D5          	push de
0359+  8650 C5          	push bc
0360+  8651 AF          	xor a
0361+  8652 0E 04       .cls1: 	ld c,4
0362+  8654 12          .cls: 	ld (de),a
0363+  8655 13          	inc de
0364+  8656 0D          	dec c
0365+  8657 20 FB       	jr nz,.cls
0366+  8659 10 F7       	djnz .cls1
0367+  865B D1          	pop de
0368+  865C E1          	pop hl
0369+  865D D5          	push de
0370+  865E AF          	xor a
0371+  865F CD B5 85    	call SetPalette
0372+  8662 76          	halt
0373+  8663 C1          	pop bc
0374+  8664 EB          	ex de,hl
0375+  8665 E1          	pop hl
0376+  8666 3E 40       	ld a,64	
0377+  8668             .unfadeloop: 
0378+  8668 F5          	push af
0379+  8669 E5          	push hl
0380+  866A D5          	push de
0381+  866B C5          	push bc
0382+  866C C5          	push bc
0383+  866D D5          	push de
0384+  866E 0E 03       .loop1: 	ld c,3
0385+  8670 1A          .loop: 	ld a,(de)
0386+  8671 C6 04       	add 4
0387+  8673 BE          	cp (hl)
0388+  8674 38 01       	jr c,.next
0389+  8676 7E          	ld a,(hl)
0390+  8677 12          .next: 	ld (de),a
0391+  8678 23          	inc hl
0392+  8679 13          	inc de
0393+  867A 0D          	dec c
0394+  867B 20 F3       	jr nz,.loop
0395+  867D 23          	inc hl
0396+  867E 13          	inc de
0397+  867F 10 ED       	djnz .loop1
0398+  8681 E1          	pop hl
0399+  8682 D1          	pop de
0400+  8683 76          	halt
0401+  8684 AF          	xor a
0402+  8685 CD B5 85    	call SetPalette
0403+  8688 C1          	pop bc
0404+  8689 D1          	pop de
0405+  868A E1          	pop hl
0406+  868B F1          	pop af
0407+  868C 3D          	dec a
0408+  868D 20 D9       	jr nz,.unfadeloop
0409+  868F C5          	push bc
0410+  8690 D1          	pop de
0411+  8691 AF          	xor a
0412+  8692 CD B5 85    	call SetPalette
0413+  8695 C9          	ret
0414+  8696             
0415+  8696             ;HL - temp buffer with current pallette
0416+  8696             ;D - Colors count
0417+  8696             ;E - Start color number
0418+  8696             FadePallete: 
0419+  8696 FB          	ei
0420+  8697 3E 40       	ld a,64
0421+  8699             .fadeloop: 
0422+  8699 F5          	push af
0423+  869A E5          	push hl
0424+  869B 42          	ld b,d
0425+  869C 0E 03       .loop1: 	ld c,3
0426+  869E 7E          .loop: 	ld a,(hl)
0427+  869F D6 04       	sub 4
0428+  86A1 30 01       	jr nc,.next
0429+  86A3 AF          	xor a
0430+  86A4 77          .next: 	ld (hl),a
0431+  86A5 23          	inc hl
0432+  86A6 0D          	dec c
0433+  86A7 20 F5       	jr nz,.loop
0434+  86A9 23          	inc hl
0435+  86AA 10 F0       	djnz .loop1
0436+  86AC E1          	pop hl
0437+  86AD 76          	halt
0438+  86AE 97                  sub a
0439+  86AF CD B5 85    	call SetPalette
0440+  86B2 F1          	pop af
0441+  86B3 3D          	dec a
0442+  86B4 20 E3       	jr nz,.fadeloop
0443+  86B6 C9          	ret
0444+  86B7             
0445+  86B7             ADDR: 	EQU	#C000
0446+  86B7             OldVideoMode: 
0447+  86B7 00          	DB	0
0448+  86B8             OldVideoPage: 
0449+  86B8 00          	DB	0
0571   86B9                             include "sys_utils.asm"
0001+  86B9             WaitSpaceKey: 
0002+  86B9             .loop
0003+  86B9 0E 31       	ld	c,Dss.ScanKey
0004+  86BB D7          	rst	#10
0005+  86BC 28 FB       	jr	z,.loop
0006+  86BE FE 20       	cp	#20
0007+  86C0 C8          	ret	z
0008+  86C1 FE 1B       	cp	#1B
0009+  86C3 20 F4       	jr	nz,.loop
0010+  86C5 37          	scf
0011+  86C6 C9                  ret
0012+  86C7             
0013+  86C7             CheckKeys: 
0014+  86C7 0E 31       	ld	c,Dss.ScanKey
0015+  86C9 D7          	rst	#10
0016+  86CA C8          	ret	z
0017+  86CB FE 1B       	cp	#1B
0018+  86CD C0          	ret	nz
0019+  86CE 37          	scf
0020+  86CF C9                  ret
0021+  86D0             
0022+  86D0             ; процедура сохранения страницы в указнном окне.
0023+  86D0             ; C = окно (порт)
0024+  86D0             ; HL = куда сохранять.
0025+  86D0 ED 78       SavePage: 	in a,(c)
0026+  86D2 77          		ld (hl),a
0027+  86D3 C9          		ret
0028+  86D4             
0029+  86D4             ; процедура восстановления страницы в указнном окне.
0030+  86D4             ; C = окно (порт)
0031+  86D4             ; HL = от куда восстановить.
0032+  86D4 7E          RestorePage: 	ld a,(hl)
0033+  86D5 ED 79       		out (c),a
0034+  86D7 C9          		ret
0572   86D8                             include "im2_utils.asm"
0001+  86D8             ;Установка IM2 и нового вектора прерываний
0002+  86D8             ;DE - обработчик прерываний
0003+  86D8             set_im2: 
0004+  86D8                     ;устанавливаем адрес процедуры перехватчик прерываний
0005+  86D8             	; LD	de,im2_handler
0006+  86D8 21 FF 80    	LD	hl,#80FF
0007+  86DB 73          	LD	(hl),e
0008+  86DC 23          	INC	hl
0009+  86DD 72          	LD	(hl),d
0010+  86DE             
0011+  86DE             	;запуск режима IM2
0012+  86DE ED 57       	LD	a,i           	;сохранение
0013+  86E0 32 EE 86    	LD	(set_im1.save_i),a  ;     регистра прерываний
0014+  86E3 3E 80       	LD	a,#80
0015+  86E5 F3          	DI
0016+  86E6 ED 47       	LD	i,a		;i=#80
0017+  86E8 ED 5E       	IM	2
0018+  86EA FB          	EI
0019+  86EB C9                  ret
0020+  86EC             ;Восстановление режима IM1 и предыдущего значения вектора прерываний
0021+  86EC             set_im1: 
0022+  86EC F3                  di
0023+  86ED 3E 00               ld      a,0
0024+  86EF             .save_i:  equ    $-1
0025+  86EF ED 47               ld      i,a
0026+  86F1 ED 56               im      1
0027+  86F3 FB                  ei
0028+  86F4 C9                  ret
0029+  86F5             
0030+  86F5             
0573   86F5                             
0574   86F5             Palette: 
0575   86F5                             include "res_pal.asm"
0001+  86F5                     ;Palette of 146 colors
0002+  86F5 92                  db  146
0003+  86F6 C9 C0 54 00         db  0xC9, 0xC0, 0x54, 0x00
0004+  86FA 75 E0 64 00         db  0x75, 0xE0, 0x64, 0x00
0005+  86FE 98 D7 DE 00         db  0x98, 0xD7, 0xDE, 0x00
0006+  8702 DA FB E9 00         db  0xDA, 0xFB, 0xE9, 0x00
0007+  8706 CA C2 56 00         db  0xCA, 0xC2, 0x56, 0x00
0008+  870A DA FA E6 00         db  0xDA, 0xFA, 0xE6, 0x00
0009+  870E D9 F9 E3 00         db  0xD9, 0xF9, 0xE3, 0x00
0010+  8712 CC CB 73 00         db  0xCC, 0xCB, 0x73, 0x00
0011+  8716 D9 FB E8 00         db  0xD9, 0xFB, 0xE8, 0x00
0012+  871A C8 E8 BF 00         db  0xC8, 0xE8, 0xBF, 0x00
0013+  871E C8 E6 BB 00         db  0xC8, 0xE6, 0xBB, 0x00
0014+  8722 D6 DC A3 00         db  0xD6, 0xDC, 0xA3, 0x00
0015+  8726 D8 DC A5 00         db  0xD8, 0xDC, 0xA5, 0x00
0016+  872A D8 DE A8 00         db  0xD8, 0xDE, 0xA8, 0x00
0017+  872E C9 ED CF 00         db  0xC9, 0xED, 0xCF, 0x00
0018+  8732 D5 DB A1 00         db  0xD5, 0xDB, 0xA1, 0x00
0019+  8736 C8 ED D1 00         db  0xC8, 0xED, 0xD1, 0x00
0020+  873A D1 F0 E2 00         db  0xD1, 0xF0, 0xE2, 0x00
0021+  873E D0 EF E0 00         db  0xD0, 0xEF, 0xE0, 0x00
0022+  8742 D8 DC A2 00         db  0xD8, 0xDC, 0xA2, 0x00
0023+  8746 D5 DA 9D 00         db  0xD5, 0xDA, 0x9D, 0x00
0024+  874A D3 DB A0 00         db  0xD3, 0xDB, 0xA0, 0x00
0025+  874E C5 E4 B6 00         db  0xC5, 0xE4, 0xB6, 0x00
0026+  8752 D1 EF DE 00         db  0xD1, 0xEF, 0xDE, 0x00
0027+  8756 C8 EE D4 00         db  0xC8, 0xEE, 0xD4, 0x00
0028+  875A D0 ED DA 00         db  0xD0, 0xED, 0xDA, 0x00
0029+  875E D7 DC A5 00         db  0xD7, 0xDC, 0xA5, 0x00
0030+  8762 C5 E6 BA 00         db  0xC5, 0xE6, 0xBA, 0x00
0031+  8766 C3 E6 BC 00         db  0xC3, 0xE6, 0xBC, 0x00
0032+  876A D8 DB 9E 00         db  0xD8, 0xDB, 0x9E, 0x00
0033+  876E C8 E4 B1 00         db  0xC8, 0xE4, 0xB1, 0x00
0034+  8772 CC EB CC 00         db  0xCC, 0xEB, 0xCC, 0x00
0035+  8776 C8 E4 B6 00         db  0xC8, 0xE4, 0xB6, 0x00
0036+  877A D3 DA 9C 00         db  0xD3, 0xDA, 0x9C, 0x00
0037+  877E D1 EC D7 00         db  0xD1, 0xEC, 0xD7, 0x00
0038+  8782 C9 EB CE 00         db  0xC9, 0xEB, 0xCE, 0x00
0039+  8786 C5 EE D4 00         db  0xC5, 0xEE, 0xD4, 0x00
0040+  878A D6 D9 9A 00         db  0xD6, 0xD9, 0x9A, 0x00
0041+  878E C5 E4 B2 00         db  0xC5, 0xE4, 0xB2, 0x00
0042+  8792 C2 E5 BA 00         db  0xC2, 0xE5, 0xBA, 0x00
0043+  8796 C8 EF D8 00         db  0xC8, 0xEF, 0xD8, 0x00
0044+  879A C5 E3 B1 00         db  0xC5, 0xE3, 0xB1, 0x00
0045+  879E D0 EB D0 00         db  0xD0, 0xEB, 0xD0, 0x00
0046+  87A2 C8 ED D4 00         db  0xC8, 0xED, 0xD4, 0x00
0047+  87A6 CE EF DD 00         db  0xCE, 0xEF, 0xDD, 0x00
0048+  87AA C2 E4 B6 00         db  0xC2, 0xE4, 0xB6, 0x00
0049+  87AE C5 EC CF 00         db  0xC5, 0xEC, 0xCF, 0x00
0050+  87B2 C2 E3 B1 00         db  0xC2, 0xE3, 0xB1, 0x00
0051+  87B6 CF D9 9A 00         db  0xCF, 0xD9, 0x9A, 0x00
0052+  87BA C5 EB CD 00         db  0xC5, 0xEB, 0xCD, 0x00
0053+  87BE CE EC DA 00         db  0xCE, 0xEC, 0xDA, 0x00
0054+  87C2 C4 ED D1 00         db  0xC4, 0xED, 0xD1, 0x00
0055+  87C6 D1 D9 9B 00         db  0xD1, 0xD9, 0x9B, 0x00
0056+  87CA CD EB D6 00         db  0xCD, 0xEB, 0xD6, 0x00
0057+  87CE CB EB D8 00         db  0xCB, 0xEB, 0xD8, 0x00
0058+  87D2 C7 EB D4 00         db  0xC7, 0xEB, 0xD4, 0x00
0059+  87D6 BF E4 B3 00         db  0xBF, 0xE4, 0xB3, 0x00
0060+  87DA BE EB C9 00         db  0xBE, 0xEB, 0xC9, 0x00
0061+  87DE BB E2 AC 00         db  0xBB, 0xE2, 0xAC, 0x00
0062+  87E2 CC D8 93 00         db  0xCC, 0xD8, 0x93, 0x00
0063+  87E6 C2 EA C8 00         db  0xC2, 0xEA, 0xC8, 0x00
0064+  87EA C3 EC CB 00         db  0xC3, 0xEC, 0xCB, 0x00
0065+  87EE CD D8 96 00         db  0xCD, 0xD8, 0x96, 0x00
0066+  87F2 BF EB CD 00         db  0xBF, 0xEB, 0xCD, 0x00
0067+  87F6 C2 EC D0 00         db  0xC2, 0xEC, 0xD0, 0x00
0068+  87FA CF EF E0 00         db  0xCF, 0xEF, 0xE0, 0x00
0069+  87FE CA EB D5 00         db  0xCA, 0xEB, 0xD5, 0x00
0070+  8802 BF EC CD 00         db  0xBF, 0xEC, 0xCD, 0x00
0071+  8806 C2 EC CE 00         db  0xC2, 0xEC, 0xCE, 0x00
0072+  880A BD E3 B0 00         db  0xBD, 0xE3, 0xB0, 0x00
0073+  880E C3 EA CE 00         db  0xC3, 0xEA, 0xCE, 0x00
0074+  8812 84 CD 74 00         db  0x84, 0xCD, 0x74, 0x00
0075+  8816 81 CC 6F 00         db  0x81, 0xCC, 0x6F, 0x00
0076+  881A D2 D7 99 00         db  0xD2, 0xD7, 0x99, 0x00
0077+  881E C2 EA C6 00         db  0xC2, 0xEA, 0xC6, 0x00
0078+  8822 BC EA C5 00         db  0xBC, 0xEA, 0xC5, 0x00
0079+  8826 81 CC 6A 00         db  0x81, 0xCC, 0x6A, 0x00
0080+  882A 80 CB 65 00         db  0x80, 0xCB, 0x65, 0x00
0081+  882E 81 C9 61 00         db  0x81, 0xC9, 0x61, 0x00
0082+  8832 84 CB 69 00         db  0x84, 0xCB, 0x69, 0x00
0083+  8836 C7 D7 90 00         db  0xC7, 0xD7, 0x90, 0x00
0084+  883A CF DA 9C 00         db  0xCF, 0xDA, 0x9C, 0x00
0085+  883E 81 CB 69 00         db  0x81, 0xCB, 0x69, 0x00
0086+  8842 84 CB 6D 00         db  0x84, 0xCB, 0x6D, 0x00
0087+  8846 BA E2 AA 00         db  0xBA, 0xE2, 0xAA, 0x00
0088+  884A CA D8 91 00         db  0xCA, 0xD8, 0x91, 0x00
0089+  884E BC E9 C1 00         db  0xBC, 0xE9, 0xC1, 0x00
0090+  8852 BA E3 B0 00         db  0xBA, 0xE3, 0xB0, 0x00
0091+  8856 C2 E4 B3 00         db  0xC2, 0xE4, 0xB3, 0x00
0092+  885A B7 E2 AA 00         db  0xB7, 0xE2, 0xAA, 0x00
0093+  885E BE E4 B6 00         db  0xBE, 0xE4, 0xB6, 0x00
0094+  8862 CA D7 8E 00         db  0xCA, 0xD7, 0x8E, 0x00
0095+  8866 D3 D7 97 00         db  0xD3, 0xD7, 0x97, 0x00
0096+  886A C9 D8 8F 00         db  0xC9, 0xD8, 0x8F, 0x00
0097+  886E 7D CB 65 00         db  0x7D, 0xCB, 0x65, 0x00
0098+  8872 7D DF 6D 00         db  0x7D, 0xDF, 0x6D, 0x00
0099+  8876 7B DF 6C 00         db  0x7B, 0xDF, 0x6C, 0x00
0100+  887A 84 C9 67 00         db  0x84, 0xC9, 0x67, 0x00
0101+  887E CD D7 91 00         db  0xCD, 0xD7, 0x91, 0x00
0102+  8882 CC D7 8F 00         db  0xCC, 0xD7, 0x8F, 0x00
0103+  8886 C9 D5 8B 00         db  0xC9, 0xD5, 0x8B, 0x00
0104+  888A 7D CA 61 00         db  0x7D, 0xCA, 0x61, 0x00
0105+  888E 7C DD 6A 00         db  0x7C, 0xDD, 0x6A, 0x00
0106+  8892 7A DD 69 00         db  0x7A, 0xDD, 0x69, 0x00
0107+  8896 79 DD 65 00         db  0x79, 0xDD, 0x65, 0x00
0108+  889A BA E9 C2 00         db  0xBA, 0xE9, 0xC2, 0x00
0109+  889E 84 CB 71 00         db  0x84, 0xCB, 0x71, 0x00
0110+  88A2 7E CC 68 00         db  0x7E, 0xCC, 0x68, 0x00
0111+  88A6 7A CB 61 00         db  0x7A, 0xCB, 0x61, 0x00
0112+  88AA 7E C8 5F 00         db  0x7E, 0xC8, 0x5F, 0x00
0113+  88AE 7B C9 5E 00         db  0x7B, 0xC9, 0x5E, 0x00
0114+  88B2 BC E2 AD 00         db  0xBC, 0xE2, 0xAD, 0x00
0115+  88B6 C7 D7 8E 00         db  0xC7, 0xD7, 0x8E, 0x00
0116+  88BA B8 EA C4 00         db  0xB8, 0xEA, 0xC4, 0x00
0117+  88BE 76 DE 64 00         db  0x76, 0xDE, 0x64, 0x00
0118+  88C2 75 E0 63 00         db  0x75, 0xE0, 0x63, 0x00
0119+  88C6 7C DC 66 00         db  0x7C, 0xDC, 0x66, 0x00
0120+  88CA 7E C7 5D 00         db  0x7E, 0xC7, 0x5D, 0x00
0121+  88CE 7C C9 5A 00         db  0x7C, 0xC9, 0x5A, 0x00
0122+  88D2 78 C9 59 00         db  0x78, 0xC9, 0x59, 0x00
0123+  88D6 78 DB 63 00         db  0x78, 0xDB, 0x63, 0x00
0124+  88DA 75 DE 63 00         db  0x75, 0xDE, 0x63, 0x00
0125+  88DE 74 DF 61 00         db  0x74, 0xDF, 0x61, 0x00
0126+  88E2 74 DE 5F 00         db  0x74, 0xDE, 0x5F, 0x00
0127+  88E6 84 CC 72 00         db  0x84, 0xCC, 0x72, 0x00
0128+  88EA 7B CA 65 00         db  0x7B, 0xCA, 0x65, 0x00
0129+  88EE 77 CA 5F 00         db  0x77, 0xCA, 0x5F, 0x00
0130+  88F2 75 C9 59 00         db  0x75, 0xC9, 0x59, 0x00
0131+  88F6 72 C9 58 00         db  0x72, 0xC9, 0x58, 0x00
0132+  88FA B6 E2 A7 00         db  0xB6, 0xE2, 0xA7, 0x00
0133+  88FE B6 EA C0 00         db  0xB6, 0xEA, 0xC0, 0x00
0134+  8902 74 DC 5E 00         db  0x74, 0xDC, 0x5E, 0x00
0135+  8906 73 C7 58 00         db  0x73, 0xC7, 0x58, 0x00
0136+  890A 76 C7 5A 00         db  0x76, 0xC7, 0x5A, 0x00
0137+  890E 70 C9 57 00         db  0x70, 0xC9, 0x57, 0x00
0138+  8912 6F C9 57 00         db  0x6F, 0xC9, 0x57, 0x00
0139+  8916 72 DC 5E 00         db  0x72, 0xDC, 0x5E, 0x00
0140+  891A 6F CA 57 00         db  0x6F, 0xCA, 0x57, 0x00
0141+  891E 72 DB 5E 00         db  0x72, 0xDB, 0x5E, 0x00
0142+  8922 6F CB 58 00         db  0x6F, 0xCB, 0x58, 0x00
0143+  8926 47 38 54 00         db  0x47, 0x38, 0x54, 0x00
0144+  892A 91 FA E4 00         db  0x91, 0xFA, 0xE4, 0x00
0145+  892E 3A BD 75 00         db  0x3A, 0xBD, 0x75, 0x00
0146+  8932 61 E4 9E 00         db  0x61, 0xE4, 0x9E, 0x00
0147+  8936 29 7E 56 00         db  0x29, 0x7E, 0x56, 0x00
0148+  893A 54 A7 D6 00         db  0x54, 0xA7, 0xD6, 0x00
0149+  893E             
0576   893E             PaletteEnd: 
0577   893E                             
0578   893E             
0579   893E             AppDir: 	        equ ($/80h)*80h+80h
0580   893E             AssetsDir: 	equ AppDir + 128
0581   893E             code_end: 
0582   893E             
0583   893E                             org 0xC000
0584   C000             PlayerStart: 
0585   C000                             include "pt3play.asm"
0001+  C000             	module pt3player
0002+  C000             	
0003+  C000             ;Vortex Tracker II v1.0 PT3 player for ZX Spectrum
0004+  C000             ;(c)2004,2007 S.V.Bulba <vorobey@mail.khstu.ru>
0005+  C000             ;http://bulba.untergrund.net (http://bulba.at.kz)
0006+  C000             
0007+  C000             ;Release number
0008+  C000             Release EQU "7"
0009+  C000             
0010+  C000             ;Features
0011+  C000             ;--------
0012+  C000             ;-Can be compiled at any address (i.e. no need rounding ORG
0013+  C000             ; address).
0014+  C000             ;-Variables (VARS) can be located at any address (not only after
0015+  C000             ;code block).
0016+  C000             ;-INIT subroutine detects module version and rightly generates
0017+  C000             ; both note and volume tables outside of code block (in VARS).
0018+  C000             ;-Two portamento (spc. command 3xxx) algorithms (depending of
0019+  C000             ; module version).
0020+  C000             ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
0021+  C000             ; and higher).
0022+  C000             ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
0023+  C000             ;-Fully compatible with Ay_Emul PT3 player codes.
0024+  C000             ;-See also notes at the end of this source code.
0025+  C000             
0026+  C000             ;Limitations
0027+  C000             ;-----------
0028+  C000             ;-Can run in RAM only (self-modified code is used).
0029+  C000             
0030+  C000             ;Warning!!! PLAY subroutine can crash if no module are loaded
0031+  C000             ;into RAM or INIT subroutine was not called before.
0032+  C000             
0033+  C000             ;Call MUTE or INIT one more time to mute sound after stopping
0034+  C000             ;playing 
0035+  C000             
0036+  C000             	;ORG #C000
0037+  C000             
0038+  C000             ;Test codes (commented)
0039+  C000             ;	CALL START
0040+  C000             ;	EI
0041+  C000             ;_LP	HALT
0042+  C000             ;	CALL START+5
0043+  C000             ;	XOR A
0044+  C000             ;	IN A,(#FE)
0045+  C000             ;	CPL
0046+  C000             ;	AND 15
0047+  C000             ;	JR Z,_LP
0048+  C000             ;	JR START+8
0049+  C000             
0050+  C000             TonA	EQU 0
0051+  C000             TonB	EQU 2
0052+  C000             TonC	EQU 4
0053+  C000             Noise	EQU 6
0054+  C000             Mixer	EQU 7
0055+  C000             AmplA	EQU 8
0056+  C000             AmplB	EQU 9
0057+  C000             AmplC	EQU 10
0058+  C000             Env	EQU 11
0059+  C000             EnvTp	EQU 13
0060+  C000             
0061+  C000             ;Entry and other points
0062+  C000             ;START initialization
0063+  C000             ;START+3 initialization with module address in HL
0064+  C000             ;START+5 play one quark
0065+  C000             ;START+8 mute
0066+  C000             ;START+10 setup and status flags
0067+  C000             ;START+11 pointer to current position value in PT3 module;
0068+  C000             ;After INIT (START+11) points to Postion0-1 (optimization)
0069+  C000             
0070+  C000             START
0071+  C000 21 6E C8    	LD HL,MDLADDR
0072+  C003 18 3A       	JR INIT
0073+  C005 C3 B9 C4    	JP PLAY
0074+  C008 18 29       	JR MUTE
0075+  C00A 00          SETUP	DB 0 ;set bit0 to 1, if you want to play without looping
0076+  C00B             	     ;bit7 is set each time, when loop point is passed
0077+  C00B 00 00       CrPsPtr	DW 0 
0078+  C00D             
0079+  C00D             ;Identifier
0080+  C00D             	DB "=VTII PT3 Player r.",Release,"="
0080+  C00D 3D565449492050543320506C6179657220722E373D
0081+  C022             
0082+  C022 21 0A C0    CHECKLP	LD HL,SETUP
0083+  C025 CB FE       	SET 7,(HL)
0084+  C027 CB 46       	BIT 0,(HL)
0085+  C029 C8          	RET Z
0086+  C02A E1          	POP HL
0087+  C02B 21 A8 C6    	LD HL,DelyCnt
0088+  C02E 34          	INC (HL)
0089+  C02F 21 6C C6    	LD HL,ChanA+CHP.NtSkCn
0090+  C032 34          	INC (HL)
0091+  C033 AF          MUTE	XOR A
0092+  C034 67          	LD H,A
0093+  C035 6F          	LD L,A
0094+  C036 32 B6 C6    	LD (AYREGS+AmplA),A
0095+  C039 22 B7 C6    	LD (AYREGS+AmplB),HL
0096+  C03C C3 AB C5    	JP ROUT_A0
0097+  C03F             
0098+  C03F             INIT
0099+  C03F             ;HL - AddressOfModule
0100+  C03F             
0101+  C03F 22 A8 C1    	LD (MODADDR),HL
0102+  C042 22 3E C3    	LD (MDADDR2),HL
0103+  C045 E5          	PUSH HL
0104+  C046 11 64 00    	LD DE,100
0105+  C049 19          	ADD HL,DE
0106+  C04A 7E          	LD A,(HL)
0107+  C04B 32 45 C5    	LD (Delay),A
0108+  C04E E5          	PUSH HL
0109+  C04F DD E1       	POP IX
0110+  C051 19          	ADD HL,DE
0111+  C052 22 0B C0    	LD (CrPsPtr),HL
0112+  C055 DD 5E 02    	LD E,(IX+102-100)
0113+  C058 19          	ADD HL,DE
0114+  C059 23          	INC HL
0115+  C05A 22 E7 C4    	LD (LPosPtr),HL
0116+  C05D D1          	POP DE
0117+  C05E DD 6E 03    	LD L,(IX+103-100)
0118+  C061 DD 66 04    	LD H,(IX+104-100)
0119+  C064 19          	ADD HL,DE
0120+  C065 22 F4 C4    	LD (PatsPtr),HL
0121+  C068 21 A9 00    	LD HL,169
0122+  C06B 19          	ADD HL,DE
0123+  C06C 22 37 C3    	LD (OrnPtrs),HL
0124+  C06F 21 69 00    	LD HL,105
0125+  C072 19          	ADD HL,DE
0126+  C073 22 A1 C1    	LD (SamPtrs),HL
0127+  C076 21 0A C0    	LD HL,SETUP
0128+  C079 CB BE       	RES 7,(HL)
0129+  C07B             
0130+  C07B             ;note table data depacker
0131+  C07B 11 1C C6    	LD DE,T_PACK
0132+  C07E 01 1F C7    	LD BC,T1_+(2*49)-1
0133+  C081 1A          TP_0	LD A,(DE)
0134+  C082 13          	INC DE
0135+  C083 FE 1E       	CP 15*2
0136+  C085 30 06       	JR NC,TP_1
0137+  C087 67          	LD H,A
0138+  C088 1A          	LD A,(DE)
0139+  C089 6F          	LD L,A
0140+  C08A 13          	INC DE
0141+  C08B 18 07       	JR TP_2
0142+  C08D D5          TP_1	PUSH DE
0143+  C08E 16 00       	LD D,0
0144+  C090 5F          	LD E,A
0145+  C091 19          	ADD HL,DE
0146+  C092 19          	ADD HL,DE
0147+  C093 D1          	POP DE
0148+  C094 7C          TP_2	LD A,H
0149+  C095 02          	LD (BC),A
0150+  C096 0B          	DEC BC
0151+  C097 7D          	LD A,L
0152+  C098 02          	LD (BC),A
0153+  C099 0B          	DEC BC
0154+  C09A D6 F0       	SUB (#F8*2)&255
0155+  C09C 20 E3       	JR NZ,TP_0
0156+  C09E             
0157+  C09E 21 51 C6    	LD HL,VARS
0158+  C0A1 77          	LD (HL),A
0159+  C0A2 11 52 C6    	LD DE,VARS+1
0160+  C0A5 01 6C 00    	LD BC,VAR0END-VARS-1
0161+  C0A8 ED B0       	LDIR
0162+  C0AA 3C          	INC A
0163+  C0AB 32 A8 C6    	LD (DelyCnt),A
0164+  C0AE 21 01 F0    	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
0165+  C0B1 22 6C C6    	LD (ChanA+CHP.NtSkCn),HL
0166+  C0B4 22 89 C6    	LD (ChanB+CHP.NtSkCn),HL
0167+  C0B7 22 A6 C6    	LD (ChanC+CHP.NtSkCn),HL
0168+  C0BA             
0169+  C0BA 21 18 C6    	LD HL,EMPTYSAMORN
0170+  C0BD 22 D1 C4    	LD (AdInPtA),HL ;ptr to zero
0171+  C0C0 22 5E C6    	LD (ChanA+CHP.OrnPtr),HL ;ornament 0 is "0,1,0"
0172+  C0C3 22 7B C6    	LD (ChanB+CHP.OrnPtr),HL ;in all versions from
0173+  C0C6 22 98 C6    	LD (ChanC+CHP.OrnPtr),HL ;3.xx to 3.6x and VTII
0174+  C0C9             
0175+  C0C9 22 60 C6    	LD (ChanA+CHP.SamPtr),HL ;S1 There is no default
0176+  C0CC 22 7D C6    	LD (ChanB+CHP.SamPtr),HL ;S2 sample in PT3, so, you
0177+  C0CF 22 9A C6    	LD (ChanC+CHP.SamPtr),HL ;S3 can comment S1,2,3; see
0178+  C0D2             				    ;also EMPTYSAMORN comment
0179+  C0D2             
0180+  C0D2 DD 7E A9    	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
0181+  C0D5 D6 30       	SUB #30
0182+  C0D7 38 04       	JR C,L20
0183+  C0D9 FE 0A       	CP 10
0184+  C0DB 38 02       	JR C,L21
0185+  C0DD 3E 06       L20	LD A,6
0186+  C0DF 32 8D C2    L21	LD (Version),A
0187+  C0E2 F5          	PUSH AF
0188+  C0E3 FE 04       	CP 4
0189+  C0E5 DD 7E FF    	LD A,(IX+99-100) ;TONE TABLE NUMBER
0190+  C0E8 17          	RLA
0191+  C0E9 E6 07       	AND 7
0192+  C0EB             
0193+  C0EB             ;NoteTableCreator (c) Ivan Roshin
0194+  C0EB             ;A - NoteTableNumber*2+VersionForNoteTable
0195+  C0EB             ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
0196+  C0EB             
0197+  C0EB 21 C8 C5    	LD HL,NT_DATA
0198+  C0EE D5          	PUSH DE
0199+  C0EF 50          	LD D,B
0200+  C0F0 87          	ADD A,A
0201+  C0F1 5F          	LD E,A
0202+  C0F2 19          	ADD HL,DE
0203+  C0F3 5E          	LD E,(HL)
0204+  C0F4 23          	INC HL
0205+  C0F5 CB 3B       	SRL E
0206+  C0F7 9F          	SBC A,A
0207+  C0F8 E6 A7       	AND #A7 ;#00 (NOP) or #A7 (AND A)
0208+  C0FA 32 20 C1    	LD (L3),A
0209+  C0FD EB          	EX DE,HL
0210+  C0FE C1          	POP BC ;BC=T1_
0211+  C0FF 09          	ADD HL,BC
0212+  C100             
0213+  C100 1A          	LD A,(DE)
0214+  C101 C6 D8       	ADD A,T_&255
0215+  C103 4F          	LD C,A
0216+  C104 CE C5       	ADC A,T_/256
0217+  C106 91          	SUB C
0218+  C107 47          	LD B,A
0219+  C108 C5          	PUSH BC
0220+  C109 11 AE C7    	LD DE,NT_
0221+  C10C D5          	PUSH DE
0222+  C10D             
0223+  C10D 06 0C       	LD B,12
0224+  C10F C5          L1	PUSH BC
0225+  C110 4E          	LD C,(HL)
0226+  C111 23          	INC HL
0227+  C112 E5          	PUSH HL
0228+  C113 46          	LD B,(HL)
0229+  C114             
0230+  C114 D5          	PUSH DE
0231+  C115 EB          	EX DE,HL
0232+  C116 11 17 00    	LD DE,23
0233+  C119 DD 26 08    	LD IXH,8
0234+  C11C             
0235+  C11C CB 38       L2	SRL B
0236+  C11E CB 19       	RR C
0237+  C120 19          L3	DB #19	;AND A or NOP
0238+  C121 79          	LD A,C
0239+  C122 8A          	ADC A,D	;=ADC 0
0240+  C123 77          	LD (HL),A
0241+  C124 23          	INC HL
0242+  C125 78          	LD A,B
0243+  C126 8A          	ADC A,D
0244+  C127 77          	LD (HL),A
0245+  C128 19          	ADD HL,DE
0246+  C129 DD 25       	DEC IXH
0247+  C12B 20 EF       	JR NZ,L2
0248+  C12D             
0249+  C12D D1          	POP DE
0250+  C12E 13          	INC DE
0251+  C12F 13          	INC DE
0252+  C130 E1          	POP HL
0253+  C131 23          	INC HL
0254+  C132 C1          	POP BC
0255+  C133 10 DA       	DJNZ L1
0256+  C135             
0257+  C135 E1          	POP HL
0258+  C136 D1          	POP DE
0259+  C137             
0260+  C137 7B          	LD A,E
0261+  C138 FE E4       	CP TCOLD_1&255
0262+  C13A 20 05       	JR NZ,CORR_1
0263+  C13C 3E FD       	LD A,#FD
0264+  C13E 32 DC C7    	LD (NT_+#2E),A
0265+  C141             
0266+  C141 1A          CORR_1	LD A,(DE)
0267+  C142 A7          	AND A
0268+  C143 28 11       	JR Z,TC_EXIT
0269+  C145 1F          	RRA
0270+  C146 F5          	PUSH AF
0271+  C147 87          	ADD A,A
0272+  C148 4F          	LD C,A
0273+  C149 09          	ADD HL,BC
0274+  C14A F1          	POP AF
0275+  C14B 30 02       	JR NC,CORR_2
0276+  C14D 35          	DEC (HL)
0277+  C14E 35          	DEC (HL)
0278+  C14F 34          CORR_2	INC (HL)
0279+  C150 A7          	AND A
0280+  C151 ED 42       	SBC HL,BC
0281+  C153 13          	INC DE
0282+  C154 18 EB       	JR CORR_1
0283+  C156             
0284+  C156             TC_EXIT
0285+  C156             
0286+  C156 F1          	POP AF
0287+  C157             
0288+  C157             ;VolTableCreator (c) Ivan Roshin
0289+  C157             ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
0290+  C157             			   ;5.. - 3.5x..3.6x..VTII1.0)
0291+  C157             
0292+  C157 FE 05       	CP 5
0293+  C159 21 11 00    	LD HL,#11
0294+  C15C 54          	LD D,H
0295+  C15D 5C          	LD E,H
0296+  C15E 3E 17       	LD A,#17
0297+  C160 30 03       	JR NC,M1
0298+  C162 2D          	DEC L
0299+  C163 5D          	LD E,L
0300+  C164 AF          	XOR A
0301+  C165 32 74 C1    M1      LD (M2),A
0302+  C168             
0303+  C168 DD 21 BE C6 	LD IX,VT_+16
0304+  C16C 0E 10       	LD C,#10
0305+  C16E             
0306+  C16E E5          INITV2  PUSH HL
0307+  C16F             
0308+  C16F 19          	ADD HL,DE
0309+  C170 EB          	EX DE,HL
0310+  C171 ED 62       	SBC HL,HL
0311+  C173             
0312+  C173 7D          INITV1  LD A,L
0313+  C174 7D          M2      DB #7D
0314+  C175 7C          	LD A,H
0315+  C176 CE 00       	ADC A,0
0316+  C178 DD 77 00    	LD (IX),A
0317+  C17B DD 23       	INC IX
0318+  C17D 19          	ADD HL,DE
0319+  C17E 0C          	INC C
0320+  C17F 79          	LD A,C
0321+  C180 E6 0F       	AND 15
0322+  C182 20 EF       	JR NZ,INITV1
0323+  C184             
0324+  C184 E1          	POP HL
0325+  C185 7B          	LD A,E
0326+  C186 FE 77       	CP #77
0327+  C188 20 01       	JR NZ,M3
0328+  C18A 1C          	INC E
0329+  C18B 79          M3      LD A,C
0330+  C18C A7          	AND A
0331+  C18D 20 DF       	JR NZ,INITV2
0332+  C18F             
0333+  C18F C3 AB C5    	JP ROUT_A0
0334+  C192             
0335+  C192             ;pattern decoder
0336+  C192 DD 36 08 00 PD_OrSm	LD (IX-12+CHP.Env_En),0
0337+  C196 CD 2F C3    	CALL SETORN
0338+  C199 0A          	LD A,(BC)
0339+  C19A 03          	INC BC
0340+  C19B 0F          	RRCA
0341+  C19C             
0342+  C19C 87          PD_SAM	ADD A,A
0343+  C19D 5F          PD_SAM_	LD E,A
0344+  C19E 16 00       	LD D,0
0345+  C1A0             SamPtrs EQU $+1
0346+  C1A0 21 21 21    	LD HL,#2121
0347+  C1A3 19          	ADD HL,DE
0348+  C1A4 5E          	LD E,(HL)
0349+  C1A5 23          	INC HL
0350+  C1A6 56          	LD D,(HL)
0351+  C1A7             MODADDR EQU $+1
0352+  C1A7 21 21 21    	LD HL,#2121
0353+  C1AA 19          	ADD HL,DE
0354+  C1AB DD 75 03    	LD (IX-12+CHP.SamPtr),L
0355+  C1AE DD 74 04    	LD (IX-12+CHP.SamPtr+1),H
0356+  C1B1 18 41       	JR PD_LOOP
0357+  C1B3             
0358+  C1B3 07          PD_VOL	RLCA
0359+  C1B4 07          	RLCA
0360+  C1B5 07          	RLCA
0361+  C1B6 07          	RLCA
0362+  C1B7 DD 77 10    	LD (IX-12+CHP.Volume),A
0363+  C1BA 18 3B       	JR PD_LP2
0364+  C1BC             	
0365+  C1BC DD 77 08    PD_EOff	LD (IX-12+CHP.Env_En),A
0366+  C1BF DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0367+  C1C2 18 33       	JR PD_LP2
0368+  C1C4             
0369+  C1C4 3D          PD_SorE	DEC A
0370+  C1C5 20 07       	JR NZ,PD_ENV
0371+  C1C7 0A          	LD A,(BC)
0372+  C1C8 03          	INC BC
0373+  C1C9 DD 77 05    	LD (IX-12+CHP.NNtSkp),A
0374+  C1CC 18 29       	JR PD_LP2
0375+  C1CE             
0376+  C1CE CD 13 C3    PD_ENV	CALL SETENV
0377+  C1D1 18 24       	JR PD_LP2
0378+  C1D3             
0379+  C1D3 CD 2F C3    PD_ORN	CALL SETORN
0380+  C1D6 18 1C       	JR PD_LOOP
0381+  C1D8             
0382+  C1D8 DD 77 08    PD_ESAM	LD (IX-12+CHP.Env_En),A
0383+  C1DB DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0384+  C1DE C4 13 C3    	CALL NZ,SETENV
0385+  C1E1 0A          	LD A,(BC)
0386+  C1E2 03          	INC BC
0387+  C1E3 18 B8       	JR PD_SAM_
0388+  C1E5             
0389+  C1E5 DD 7E 06    PTDECOD LD A,(IX-12+CHP.Note)
0390+  C1E8 32 71 C2    	LD (PrNote+1),A
0391+  C1EB DD 6E FA    	LD L,(IX-12+CHP.CrTnSl)
0392+  C1EE DD 66 FB    	LD H,(IX-12+CHP.CrTnSl+1)
0393+  C1F1 22 93 C2    	LD (PrSlide+1),HL
0394+  C1F4             
0395+  C1F4 11 10 20    PD_LOOP	LD DE,#2010
0396+  C1F7 0A          PD_LP2	LD A,(BC)
0397+  C1F8 03          	INC BC
0398+  C1F9 83          	ADD A,E
0399+  C1FA 38 96       	JR C,PD_OrSm
0400+  C1FC 82          	ADD A,D
0401+  C1FD 28 49       	JR Z,PD_FIN
0402+  C1FF 38 9B       	JR C,PD_SAM
0403+  C201 83          	ADD A,E
0404+  C202 28 25       	JR Z,PD_REL
0405+  C204 38 AD       	JR C,PD_VOL
0406+  C206 83          	ADD A,E
0407+  C207 28 B3       	JR Z,PD_EOff
0408+  C209 38 B9       	JR C,PD_SorE
0409+  C20B C6 60       	ADD A,96
0410+  C20D 38 20       	JR C,PD_NOTE
0411+  C20F 83          	ADD A,E
0412+  C210 38 C1       	JR C,PD_ORN
0413+  C212 82          	ADD A,D
0414+  C213 38 0F       	JR C,PD_NOIS
0415+  C215 83          	ADD A,E
0416+  C216 38 C0       	JR C,PD_ESAM
0417+  C218 87          	ADD A,A
0418+  C219 5F          	LD E,A
0419+  C21A 21 68 A2    	LD HL,(SPCCOMS+#FF20-#2000)&65535
0420+  C21D 19          	ADD HL,DE
0421+  C21E 5E          	LD E,(HL)
0422+  C21F 23          	INC HL
0423+  C220 56          	LD D,(HL)
0424+  C221 D5          	PUSH DE
0425+  C222 18 D0       	JR PD_LOOP
0426+  C224             
0427+  C224 32 AC C6    PD_NOIS	LD (Ns_Base),A
0428+  C227 18 CE       	JR PD_LP2
0429+  C229             
0430+  C229 DD CB 09 86 PD_REL	RES 0,(IX-12+CHP.Flags)
0431+  C22D 18 08       	JR PD_RES
0432+  C22F             	
0433+  C22F DD 77 06    PD_NOTE	LD (IX-12+CHP.Note),A
0434+  C232 DD CB 09 C6 	SET 0,(IX-12+CHP.Flags)
0435+  C236 AF          	XOR A
0436+  C237             
0437+  C237 ED 73 46 C2 PD_RES	LD (PDSP_+1),SP
0438+  C23B DD F9       	LD SP,IX
0439+  C23D 67          	LD H,A
0440+  C23E 6F          	LD L,A
0441+  C23F E5          	PUSH HL
0442+  C240 E5          	PUSH HL
0443+  C241 E5          	PUSH HL
0444+  C242 E5          	PUSH HL
0445+  C243 E5          	PUSH HL
0446+  C244 E5          	PUSH HL
0447+  C245 31 31 31    PDSP_	LD SP,#3131
0448+  C248             
0449+  C248 DD 7E 05    PD_FIN	LD A,(IX-12+CHP.NNtSkp)
0450+  C24B DD 77 0F    	LD (IX-12+CHP.NtSkCn),A
0451+  C24E C9          	RET
0452+  C24F             
0453+  C24F DD CB 09 96 C_PORTM RES 2,(IX-12+CHP.Flags)
0454+  C253 0A          	LD A,(BC)
0455+  C254 03          	INC BC
0456+  C255             ;SKIP PRECALCULATED TONE DELTA (BECAUSE
0457+  C255             ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
0458+  C255 03          	INC BC
0459+  C256 03          	INC BC
0460+  C257 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0461+  C25A DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0462+  C25D 11 AE C7    	LD DE,NT_
0463+  C260 DD 7E 06    	LD A,(IX-12+CHP.Note)
0464+  C263 DD 77 07    	LD (IX-12+CHP.SlToNt),A
0465+  C266 87          	ADD A,A
0466+  C267 6F          	LD L,A
0467+  C268 26 00       	LD H,0
0468+  C26A 19          	ADD HL,DE
0469+  C26B 7E          	LD A,(HL)
0470+  C26C 23          	INC HL
0471+  C26D 66          	LD H,(HL)
0472+  C26E 6F          	LD L,A
0473+  C26F E5          	PUSH HL
0474+  C270 3E 3E       PrNote	LD A,#3E
0475+  C272 DD 77 06    	LD (IX-12+CHP.Note),A
0476+  C275 87          	ADD A,A
0477+  C276 6F          	LD L,A
0478+  C277 26 00       	LD H,0
0479+  C279 19          	ADD HL,DE
0480+  C27A 5E          	LD E,(HL)
0481+  C27B 23          	INC HL
0482+  C27C 56          	LD D,(HL)
0483+  C27D E1          	POP HL
0484+  C27E ED 52       	SBC HL,DE
0485+  C280 DD 75 0D    	LD (IX-12+CHP.TnDelt),L
0486+  C283 DD 74 0E    	LD (IX-12+CHP.TnDelt+1),H
0487+  C286 DD 5E FA    	LD E,(IX-12+CHP.CrTnSl)
0488+  C289 DD 56 FB    	LD D,(IX-12+CHP.CrTnSl+1)
0489+  C28C             Version EQU $+1
0490+  C28C 3E 3E       	LD A,#3E
0491+  C28E FE 06       	CP 6
0492+  C290 38 09       	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
0493+  C292 11 11 11    PrSlide	LD DE,#1111
0494+  C295 DD 73 FA    	LD (IX-12+CHP.CrTnSl),E
0495+  C298 DD 72 FB    	LD (IX-12+CHP.CrTnSl+1),D
0496+  C29B 0A          OLDPRTM	LD A,(BC) ;SIGNED TONE STEP
0497+  C29C 03          	INC BC
0498+  C29D 08          	EX AF,AF'
0499+  C29E 0A          	LD A,(BC)
0500+  C29F 03          	INC BC
0501+  C2A0 A7          	AND A
0502+  C2A1 28 01       	JR Z,NOSIG
0503+  C2A3 EB          	EX DE,HL
0504+  C2A4 ED 52       NOSIG	SBC HL,DE
0505+  C2A6 F2 AE C2    	JP P,SET_STP
0506+  C2A9 2F          	CPL
0507+  C2AA 08          	EX AF,AF'
0508+  C2AB ED 44       	NEG
0509+  C2AD 08          	EX AF,AF'
0510+  C2AE DD 77 0C    SET_STP	LD (IX-12+CHP.TSlStp+1),A
0511+  C2B1 08          	EX AF,AF'
0512+  C2B2 DD 77 0B    	LD (IX-12+CHP.TSlStp),A
0513+  C2B5 DD 36 FE 00 	LD (IX-12+CHP.COnOff),0
0514+  C2B9 C9          	RET
0515+  C2BA             
0516+  C2BA DD CB 09 D6 C_GLISS	SET 2,(IX-12+CHP.Flags)
0517+  C2BE 0A          	LD A,(BC)
0518+  C2BF 03          	INC BC
0519+  C2C0 DD 77 0A    	LD (IX-12+CHP.TnSlDl),A
0520+  C2C3 A7          	AND A
0521+  C2C4 20 07       	JR NZ,GL36
0522+  C2C6 3A 8D C2    	LD A,(Version) ;AlCo PT3.7+
0523+  C2C9 FE 07       	CP 7
0524+  C2CB 9F          	SBC A,A
0525+  C2CC 3C          	INC A
0526+  C2CD DD 77 F9    GL36	LD (IX-12+CHP.TSlCnt),A
0527+  C2D0 0A          	LD A,(BC)
0528+  C2D1 03          	INC BC
0529+  C2D2 08          	EX AF,AF'
0530+  C2D3 0A          	LD A,(BC)
0531+  C2D4 03          	INC BC
0532+  C2D5 18 D7       	JR SET_STP
0533+  C2D7             
0534+  C2D7 0A          C_SMPOS	LD A,(BC)
0535+  C2D8 03          	INC BC
0536+  C2D9 DD 77 F5    	LD (IX-12+CHP.PsInSm),A
0537+  C2DC C9          	RET
0538+  C2DD             
0539+  C2DD 0A          C_ORPOS	LD A,(BC)
0540+  C2DE 03          	INC BC
0541+  C2DF DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0542+  C2E2 C9          	RET
0543+  C2E3             
0544+  C2E3 0A          C_VIBRT	LD A,(BC)
0545+  C2E4 03          	INC BC
0546+  C2E5 DD 77 FF    	LD (IX-12+CHP.OnOffD),A
0547+  C2E8 DD 77 FE    	LD (IX-12+CHP.COnOff),A
0548+  C2EB 0A          	LD A,(BC)
0549+  C2EC 03          	INC BC
0550+  C2ED DD 77 00    	LD (IX-12+CHP.OffOnD),A
0551+  C2F0 AF          	XOR A
0552+  C2F1 DD 77 F9    	LD (IX-12+CHP.TSlCnt),A
0553+  C2F4 DD 77 FA    	LD (IX-12+CHP.CrTnSl),A
0554+  C2F7 DD 77 FB    	LD (IX-12+CHP.CrTnSl+1),A
0555+  C2FA C9          	RET
0556+  C2FB             
0557+  C2FB 0A          C_ENGLS	LD A,(BC)
0558+  C2FC 03          	INC BC
0559+  C2FD 32 A1 C5    	LD (Env_Del),A
0560+  C300 32 AB C6    	LD (CurEDel),A
0561+  C303 0A          	LD A,(BC)
0562+  C304 03          	INC BC
0563+  C305 6F          	LD L,A
0564+  C306 0A          	LD A,(BC)
0565+  C307 03          	INC BC
0566+  C308 67          	LD H,A
0567+  C309 22 A4 C5    	LD (ESldAdd),HL
0568+  C30C C9          	RET
0569+  C30D             
0570+  C30D 0A          C_DELAY	LD A,(BC)
0571+  C30E 03          	INC BC
0572+  C30F 32 45 C5    	LD (Delay),A
0573+  C312 C9          	RET
0574+  C313             	
0575+  C313 DD 73 08    SETENV	LD (IX-12+CHP.Env_En),E
0576+  C316 32 BB C6    	LD (AYREGS+EnvTp),A
0577+  C319 0A          	LD A,(BC)
0578+  C31A 03          	INC BC
0579+  C31B 67          	LD H,A
0580+  C31C 0A          	LD A,(BC)
0581+  C31D 03          	INC BC
0582+  C31E 6F          	LD L,A
0583+  C31F 22 BC C6    	LD (EnvBase),HL
0584+  C322 AF          	XOR A
0585+  C323 DD 77 F4    	LD (IX-12+CHP.PsInOr),A
0586+  C326 32 AB C6    	LD (CurEDel),A
0587+  C329 67          	LD H,A
0588+  C32A 6F          	LD L,A
0589+  C32B 22 A9 C6    	LD (CurESld),HL
0590+  C32E C9          C_NOP	RET
0591+  C32F             
0592+  C32F 87          SETORN	ADD A,A
0593+  C330 5F          	LD E,A
0594+  C331 16 00       	LD D,0
0595+  C333 DD 72 F4    	LD (IX-12+CHP.PsInOr),D
0596+  C336             OrnPtrs	EQU $+1
0597+  C336 21 21 21    	LD HL,#2121
0598+  C339 19          	ADD HL,DE
0599+  C33A 5E          	LD E,(HL)
0600+  C33B 23          	INC HL
0601+  C33C 56          	LD D,(HL)
0602+  C33D             MDADDR2	EQU $+1
0603+  C33D 21 21 21    	LD HL,#2121
0604+  C340 19          	ADD HL,DE
0605+  C341 DD 75 01    	LD (IX-12+CHP.OrnPtr),L
0606+  C344 DD 74 02    	LD (IX-12+CHP.OrnPtr+1),H
0607+  C347 C9          	RET
0608+  C348             
0609+  C348             ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0610+  C348 2E C3       SPCCOMS DW C_NOP
0611+  C34A BA C2       	DW C_GLISS
0612+  C34C 4F C2       	DW C_PORTM
0613+  C34E D7 C2       	DW C_SMPOS
0614+  C350 DD C2       	DW C_ORPOS
0615+  C352 E3 C2       	DW C_VIBRT
0616+  C354 2E C3       	DW C_NOP
0617+  C356 2E C3       	DW C_NOP
0618+  C358 FB C2       	DW C_ENGLS
0619+  C35A 0D C3       	DW C_DELAY
0620+  C35C 2E C3       	DW C_NOP
0621+  C35E 2E C3       	DW C_NOP
0622+  C360 2E C3       	DW C_NOP
0623+  C362 2E C3       	DW C_NOP
0624+  C364 2E C3       	DW C_NOP
0625+  C366 2E C3       	DW C_NOP
0626+  C368             
0627+  C368 AF          CHREGS	XOR A
0628+  C369 32 B8 C6    	LD (Ampl),A
0629+  C36C DD CB 15 46 	BIT 0,(IX+CHP.Flags)
0630+  C370 E5          	PUSH HL
0631+  C371 CA 96 C4    	JP Z,CH_EXIT
0632+  C374 ED 73 E1 C3 	LD (CSP_+1),SP
0633+  C378 DD 6E 0D    	LD L,(IX+CHP.OrnPtr)
0634+  C37B DD 66 0E    	LD H,(IX+CHP.OrnPtr+1)
0635+  C37E F9          	LD SP,HL
0636+  C37F D1          	POP DE
0637+  C380 67          	LD H,A
0638+  C381 DD 7E 00    	LD A,(IX+CHP.PsInOr)
0639+  C384 6F          	LD L,A
0640+  C385 39          	ADD HL,SP
0641+  C386 3C          	INC A
0642+  C387 BA          	CP D
0643+  C388 38 01       	JR C,CH_ORPS
0644+  C38A 7B          	LD A,E
0645+  C38B DD 77 00    CH_ORPS	LD (IX+CHP.PsInOr),A
0646+  C38E DD 7E 12    	LD A,(IX+CHP.Note)
0647+  C391 86          	ADD A,(HL)
0648+  C392 F2 96 C3    	JP P,CH_NTP
0649+  C395 AF          	XOR A
0650+  C396 FE 60       CH_NTP	CP 96
0651+  C398 38 02       	JR C,CH_NOK
0652+  C39A 3E 5F       	LD A,95
0653+  C39C 87          CH_NOK	ADD A,A
0654+  C39D 08          	EX AF,AF'
0655+  C39E DD 6E 0F    	LD L,(IX+CHP.SamPtr)
0656+  C3A1 DD 66 10    	LD H,(IX+CHP.SamPtr+1)
0657+  C3A4 F9          	LD SP,HL
0658+  C3A5 D1          	POP DE
0659+  C3A6 26 00       	LD H,0
0660+  C3A8 DD 7E 01    	LD A,(IX+CHP.PsInSm)
0661+  C3AB 47          	LD B,A
0662+  C3AC 87          	ADD A,A
0663+  C3AD 87          	ADD A,A
0664+  C3AE 6F          	LD L,A
0665+  C3AF 39          	ADD HL,SP
0666+  C3B0 F9          	LD SP,HL
0667+  C3B1 78          	LD A,B
0668+  C3B2 3C          	INC A
0669+  C3B3 BA          	CP D
0670+  C3B4 38 01       	JR C,CH_SMPS
0671+  C3B6 7B          	LD A,E
0672+  C3B7 DD 77 01    CH_SMPS	LD (IX+CHP.PsInSm),A
0673+  C3BA C1          	POP BC
0674+  C3BB E1          	POP HL
0675+  C3BC DD 5E 08    	LD E,(IX+CHP.TnAcc)
0676+  C3BF DD 56 09    	LD D,(IX+CHP.TnAcc+1)
0677+  C3C2 19          	ADD HL,DE
0678+  C3C3 CB 70       	BIT 6,B
0679+  C3C5 28 06       	JR Z,CH_NOAC
0680+  C3C7 DD 75 08    	LD (IX+CHP.TnAcc),L
0681+  C3CA DD 74 09    	LD (IX+CHP.TnAcc+1),H
0682+  C3CD EB          CH_NOAC EX DE,HL
0683+  C3CE 08          	EX AF,AF'
0684+  C3CF 6F          	LD L,A
0685+  C3D0 26 00       	LD H,0
0686+  C3D2 31 AE C7    	LD SP,NT_
0687+  C3D5 39          	ADD HL,SP
0688+  C3D6 F9          	LD SP,HL
0689+  C3D7 E1          	POP HL
0690+  C3D8 19          	ADD HL,DE
0691+  C3D9 DD 5E 06    	LD E,(IX+CHP.CrTnSl)
0692+  C3DC DD 56 07    	LD D,(IX+CHP.CrTnSl+1)
0693+  C3DF 19          	ADD HL,DE
0694+  C3E0 31 31 31    CSP_	LD SP,#3131
0695+  C3E3 E3          	EX (SP),HL
0696+  C3E4 AF          	XOR A
0697+  C3E5 DD B6 05    	OR (IX+CHP.TSlCnt)
0698+  C3E8 28 3E       	JR Z,CH_AMP
0699+  C3EA DD 35 05    	DEC (IX+CHP.TSlCnt)
0700+  C3ED 20 39       	JR NZ,CH_AMP
0701+  C3EF DD 7E 16    	LD A,(IX+CHP.TnSlDl)
0702+  C3F2 DD 77 05    	LD (IX+CHP.TSlCnt),A
0703+  C3F5 DD 6E 17    	LD L,(IX+CHP.TSlStp)
0704+  C3F8 DD 66 18    	LD H,(IX+CHP.TSlStp+1)
0705+  C3FB 7C          	LD A,H
0706+  C3FC 19          	ADD HL,DE
0707+  C3FD DD 75 06    	LD (IX+CHP.CrTnSl),L
0708+  C400 DD 74 07    	LD (IX+CHP.CrTnSl+1),H
0709+  C403 DD CB 15 56 	BIT 2,(IX+CHP.Flags)
0710+  C407 20 1F       	JR NZ,CH_AMP
0711+  C409 DD 5E 19    	LD E,(IX+CHP.TnDelt)
0712+  C40C DD 56 1A    	LD D,(IX+CHP.TnDelt+1)
0713+  C40F A7          	AND A
0714+  C410 28 01       	JR Z,CH_STPP
0715+  C412 EB          	EX DE,HL
0716+  C413 ED 52       CH_STPP SBC HL,DE
0717+  C415 FA 28 C4    	JP M,CH_AMP
0718+  C418 DD 7E 13    	LD A,(IX+CHP.SlToNt)
0719+  C41B DD 77 12    	LD (IX+CHP.Note),A
0720+  C41E AF          	XOR A
0721+  C41F DD 77 05    	LD (IX+CHP.TSlCnt),A
0722+  C422 DD 77 06    	LD (IX+CHP.CrTnSl),A
0723+  C425 DD 77 07    	LD (IX+CHP.CrTnSl+1),A
0724+  C428 DD 7E 02    CH_AMP	LD A,(IX+CHP.CrAmSl)
0725+  C42B CB 79       	BIT 7,C
0726+  C42D 28 13       	JR Z,CH_NOAM
0727+  C42F CB 71       	BIT 6,C
0728+  C431 28 07       	JR Z,CH_AMIN
0729+  C433 FE 0F       	CP 15
0730+  C435 28 0B       	JR Z,CH_NOAM
0731+  C437 3C          	INC A
0732+  C438 18 05       	JR CH_SVAM
0733+  C43A FE F1       CH_AMIN	CP -15
0734+  C43C 28 04       	JR Z,CH_NOAM
0735+  C43E 3D          	DEC A
0736+  C43F DD 77 02    CH_SVAM	LD (IX+CHP.CrAmSl),A
0737+  C442 6F          CH_NOAM	LD L,A
0738+  C443 78          	LD A,B
0739+  C444 E6 0F       	AND 15
0740+  C446 85          	ADD A,L
0741+  C447 F2 4B C4    	JP P,CH_APOS
0742+  C44A AF          	XOR A
0743+  C44B FE 10       CH_APOS	CP 16
0744+  C44D 38 02       	JR C,CH_VOL
0745+  C44F 3E 0F       	LD A,15
0746+  C451 DD B6 1C    CH_VOL	OR (IX+CHP.Volume)
0747+  C454 6F          	LD L,A
0748+  C455 26 00       	LD H,0
0749+  C457 11 AE C6    	LD DE,VT_
0750+  C45A 19          	ADD HL,DE
0751+  C45B 7E          	LD A,(HL)
0752+  C45C CB 41       CH_ENV	BIT 0,C
0753+  C45E 20 03       	JR NZ,CH_NOEN
0754+  C460 DD B6 14    	OR (IX+CHP.Env_En)
0755+  C463 32 B8 C6    CH_NOEN	LD (Ampl),A
0756+  C466 CB 78       	BIT 7,B
0757+  C468 79          	LD A,C
0758+  C469 28 19       	JR Z,NO_ENSL
0759+  C46B 17          	RLA
0760+  C46C 17          	RLA
0761+  C46D CB 2F       	SRA A
0762+  C46F CB 2F       	SRA A
0763+  C471 CB 2F       	SRA A
0764+  C473 DD 86 04    	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
0765+  C476 CB 68       	BIT 5,B
0766+  C478 28 03       	JR Z,NO_ENAC
0767+  C47A DD 77 04    	LD (IX+CHP.CrEnSl),A
0768+  C47D 21 85 C5    NO_ENAC	LD HL,AddToEn
0769+  C480 86          	ADD A,(HL) ;BUG IN PT3 - NEED WORD HERE.
0770+  C481             		   ;FIX IT IN NEXT VERSION?
0771+  C481 77          	LD (HL),A
0772+  C482 18 0E       	JR CH_MIX
0773+  C484 1F          NO_ENSL RRA
0774+  C485 DD 86 03    	ADD A,(IX+CHP.CrNsSl)
0775+  C488 32 AD C6    	LD (AddToNs),A
0776+  C48B CB 68       	BIT 5,B
0777+  C48D 28 03       	JR Z,CH_MIX
0778+  C48F DD 77 03    	LD (IX+CHP.CrNsSl),A
0779+  C492 78          CH_MIX	LD A,B
0780+  C493 1F          	RRA
0781+  C494 E6 48       	AND #48
0782+  C496 21 B5 C6    CH_EXIT	LD HL,AYREGS+Mixer
0783+  C499 B6          	OR (HL)
0784+  C49A 0F          	RRCA
0785+  C49B 77          	LD (HL),A
0786+  C49C E1          	POP HL
0787+  C49D AF          	XOR A
0788+  C49E DD B6 0A    	OR (IX+CHP.COnOff)
0789+  C4A1 C8          	RET Z
0790+  C4A2 DD 35 0A    	DEC (IX+CHP.COnOff)
0791+  C4A5 C0          	RET NZ
0792+  C4A6 DD AE 15    	XOR (IX+CHP.Flags)
0793+  C4A9 DD 77 15    	LD (IX+CHP.Flags),A
0794+  C4AC 1F          	RRA
0795+  C4AD DD 7E 0B    	LD A,(IX+CHP.OnOffD)
0796+  C4B0 38 03       	JR C,CH_ONDL
0797+  C4B2 DD 7E 0C    	LD A,(IX+CHP.OffOnD)
0798+  C4B5 DD 77 0A    CH_ONDL	LD (IX+CHP.COnOff),A
0799+  C4B8 C9          	RET
0800+  C4B9             
0801+  C4B9 AF          PLAY    XOR A
0802+  C4BA 32 85 C5    	LD (AddToEn),A
0803+  C4BD 32 B5 C6    	LD (AYREGS+Mixer),A
0804+  C4C0 3D          	DEC A
0805+  C4C1 32 BB C6    	LD (AYREGS+EnvTp),A
0806+  C4C4 21 A8 C6    	LD HL,DelyCnt
0807+  C4C7 35          	DEC (HL)
0808+  C4C8 20 7F       	JR NZ,PL2
0809+  C4CA 21 6C C6    	LD HL,ChanA+CHP.NtSkCn
0810+  C4CD 35          	DEC (HL)
0811+  C4CE 20 4C       	JR NZ,PL1B
0812+  C4D0             AdInPtA	EQU $+1
0813+  C4D0 01 01 01    	LD BC,#0101
0814+  C4D3 0A          	LD A,(BC)
0815+  C4D4 A7          	AND A
0816+  C4D5 20 3A       	JR NZ,PL1A
0817+  C4D7 57          	LD D,A
0818+  C4D8 32 AC C6    	LD (Ns_Base),A
0819+  C4DB 2A 0B C0    	LD HL,(CrPsPtr)
0820+  C4DE 23          	INC HL
0821+  C4DF 7E          	LD A,(HL)
0822+  C4E0 3C          	INC A
0823+  C4E1 20 08       	JR NZ,PLNLP
0824+  C4E3 CD 22 C0    	CALL CHECKLP
0825+  C4E6             LPosPtr	EQU $+1
0826+  C4E6 21 21 21    	LD HL,#2121
0827+  C4E9 7E          	LD A,(HL)
0828+  C4EA 3C          	INC A
0829+  C4EB 22 0B C0    PLNLP	LD (CrPsPtr),HL
0830+  C4EE 3D          	DEC A
0831+  C4EF 87          	ADD A,A
0832+  C4F0 5F          	LD E,A
0833+  C4F1 CB 12       	RL D
0834+  C4F3             PatsPtr	EQU $+1
0835+  C4F3 21 21 21    	LD HL,#2121
0836+  C4F6 19          	ADD HL,DE
0837+  C4F7 ED 5B A8 C1 	LD DE,(MODADDR)
0838+  C4FB ED 73 0F C5 	LD (PSP_+1),SP
0839+  C4FF F9          	LD SP,HL
0840+  C500 E1          	POP HL
0841+  C501 19          	ADD HL,DE
0842+  C502 44          	LD B,H
0843+  C503 4D          	LD C,L
0844+  C504 E1          	POP HL
0845+  C505 19          	ADD HL,DE
0846+  C506 22 27 C5    	LD (AdInPtB),HL
0847+  C509 E1          	POP HL
0848+  C50A 19          	ADD HL,DE
0849+  C50B 22 3B C5    	LD (AdInPtC),HL
0850+  C50E 31 31 31    PSP_	LD SP,#3131
0851+  C511 DD 21 5D C6 PL1A	LD IX,ChanA+12
0852+  C515 CD E5 C1    	CALL PTDECOD
0853+  C518 ED 43 D1 C4 	LD (AdInPtA),BC
0854+  C51C             
0855+  C51C 21 89 C6    PL1B	LD HL,ChanB+CHP.NtSkCn
0856+  C51F 35          	DEC (HL)
0857+  C520 20 0E       	JR NZ,PL1C
0858+  C522 DD 21 7A C6 	LD IX,ChanB+12
0859+  C526             AdInPtB	EQU $+1
0860+  C526 01 01 01    	LD BC,#0101
0861+  C529 CD E5 C1    	CALL PTDECOD
0862+  C52C ED 43 27 C5 	LD (AdInPtB),BC
0863+  C530             
0864+  C530 21 A6 C6    PL1C	LD HL,ChanC+CHP.NtSkCn
0865+  C533 35          	DEC (HL)
0866+  C534 20 0E       	JR NZ,PL1D
0867+  C536 DD 21 97 C6 	LD IX,ChanC+12
0868+  C53A             AdInPtC	EQU $+1
0869+  C53A 01 01 01    	LD BC,#0101
0870+  C53D CD E5 C1    	CALL PTDECOD
0871+  C540 ED 43 3B C5 	LD (AdInPtC),BC
0872+  C544             
0873+  C544             Delay	EQU $+1
0874+  C544 3E 3E       PL1D	LD A,#3E
0875+  C546 32 A8 C6    	LD (DelyCnt),A
0876+  C549             
0877+  C549 DD 21 51 C6 PL2	LD IX,ChanA
0878+  C54D 2A AE C6    	LD HL,(AYREGS+TonA)
0879+  C550 CD 68 C3    	CALL CHREGS
0880+  C553 22 AE C6    	LD (AYREGS+TonA),HL
0881+  C556 3A B8 C6    	LD A,(Ampl)
0882+  C559 32 B6 C6    	LD (AYREGS+AmplA),A
0883+  C55C DD 21 6E C6 	LD IX,ChanB
0884+  C560 2A B0 C6    	LD HL,(AYREGS+TonB)
0885+  C563 CD 68 C3    	CALL CHREGS
0886+  C566 22 B0 C6    	LD (AYREGS+TonB),HL
0887+  C569 3A B8 C6    	LD A,(Ampl)
0888+  C56C 32 B7 C6    	LD (AYREGS+AmplB),A
0889+  C56F DD 21 8B C6 	LD IX,ChanC
0890+  C573 2A B2 C6    	LD HL,(AYREGS+TonC)
0891+  C576 CD 68 C3    	CALL CHREGS
0892+  C579             ;	LD A,(Ampl) ;Ampl = AYREGS+AmplC
0893+  C579             ;	LD (AYREGS+AmplC),A
0894+  C579 22 B2 C6    	LD (AYREGS+TonC),HL
0895+  C57C             
0896+  C57C 2A AC C6    	LD HL,(Ns_Base_AddToNs)
0897+  C57F 7C          	LD A,H
0898+  C580 85          	ADD A,L
0899+  C581 32 B4 C6    	LD (AYREGS+Noise),A
0900+  C584             
0901+  C584             AddToEn EQU $+1
0902+  C584 3E 3E       	LD A,#3E
0903+  C586 5F          	LD E,A
0904+  C587 87          	ADD A,A
0905+  C588 9F          	SBC A,A
0906+  C589 57          	LD D,A
0907+  C58A 2A BC C6    	LD HL,(EnvBase)
0908+  C58D 19          	ADD HL,DE
0909+  C58E ED 5B A9 C6 	LD DE,(CurESld)
0910+  C592 19          	ADD HL,DE
0911+  C593 22 B9 C6    	LD (AYREGS+Env),HL
0912+  C596             
0913+  C596 AF          	XOR A
0914+  C597 21 AB C6    	LD HL,CurEDel
0915+  C59A B6          	OR (HL)
0916+  C59B 28 0E       	JR Z,ROUT_A0
0917+  C59D 35          	DEC (HL)
0918+  C59E 20 0A       	JR NZ,ROUT
0919+  C5A0             Env_Del	EQU $+1
0920+  C5A0 3E 3E       	LD A,#3E
0921+  C5A2 77          	LD (HL),A
0922+  C5A3             ESldAdd	EQU $+1
0923+  C5A3 21 21 21    	LD HL,#2121
0924+  C5A6 19          	ADD HL,DE
0925+  C5A7 22 A9 C6    	LD (CurESld),HL
0926+  C5AA             
0927+  C5AA AF          ROUT	XOR A
0928+  C5AB 11 BF FF    ROUT_A0	LD DE,#FFBF
0929+  C5AE 01 FD FF    	LD BC,#FFFD
0930+  C5B1 21 AE C6    	LD HL,AYREGS
0931+  C5B4 ED 79       LOUT	OUT (C),A
0932+  C5B6 43          	LD B,E
0933+  C5B7 ED A3       	OUTI 
0934+  C5B9 42          	LD B,D
0935+  C5BA 3C          	INC A
0936+  C5BB FE 0D       	CP 13
0937+  C5BD 20 F5       	JR NZ,LOUT
0938+  C5BF ED 79       	OUT (C),A
0939+  C5C1 7E          	LD A,(HL)
0940+  C5C2 A7          	AND A
0941+  C5C3 F8          	RET M
0942+  C5C4 43          	LD B,E
0943+  C5C5 ED 79       	OUT (C),A
0944+  C5C7 C9          	RET
0945+  C5C8             
0946+  C5C8 64          NT_DATA	DB (T_NEW_0-T1_)*2
0947+  C5C9 2A          	DB TCNEW_0-T_
0948+  C5CA 65          	DB (T_OLD_0-T1_)*2+1
0949+  C5CB 00          	DB TCOLD_0-T_
0950+  C5CC 01          	DB (T_NEW_1-T1_)*2+1
0951+  C5CD 0C          	DB TCNEW_1-T_
0952+  C5CE 01          	DB (T_OLD_1-T1_)*2+1
0953+  C5CF 0C          	DB TCOLD_1-T_
0954+  C5D0 94          	DB (T_NEW_2-T1_)*2
0955+  C5D1 35          	DB TCNEW_2-T_
0956+  C5D2 30          	DB (T_OLD_2-T1_)*2
0957+  C5D3 0E          	DB TCOLD_2-T_
0958+  C5D4 60          	DB (T_NEW_3-T1_)*2
0959+  C5D5 20          	DB TCNEW_3-T_
0960+  C5D6 60          	DB (T_OLD_3-T1_)*2
0961+  C5D7 21          	DB TCOLD_3-T_
0962+  C5D8             
0963+  C5D8             T_
0964+  C5D8             
0965+  C5D8             TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
0965+  C5D8 0105090B0D0F1315
0966+  C5E0 19 25 3D 00 	DB #18+1,#24+1,#3C+1,0
0967+  C5E4 5D 00       TCOLD_1	DB #5C+1,0
0968+  C5E6             TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
0968+  C5E6 31374D535F71828C9C
0969+  C5EF             	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
0969+  C5EF 9EA0A6A8AAACAEAE00
0970+  C5F8 57          TCNEW_3	DB #56+1
0971+  C5F9             TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
0971+  C5F9 1F2325292D2F33BF00
0972+  C602             TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
0972+  C602 1D2123272B2D3155
0973+  C60A BD BF 00    	DB #BC+1,#BE+1,0
0974+  C60D             TCNEW_1 EQU TCOLD_1
0975+  C60D             TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
0975+  C60D 1B2125292B3B4D5F
0976+  C615 BB BD BF 00 	DB #BA+1,#BC+1,#BE+1,0
0977+  C619             
0978+  C619             EMPTYSAMORN EQU $-1
0979+  C619 01 00 90    	DB 1,0,#90 ;delete #90 if you don't need default sample
0980+  C61C             
0981+  C61C             ;first 12 values of tone tables (packed)
0982+  C61C             
0983+  C61C 0D D8       T_PACK	DB #06EC*2/256,(#06EC*2)&255
0984+  C61E 69          	DB #0755-#06EC
0985+  C61F 70          	DB #07C5-#0755
0986+  C620 76          	DB #083B-#07C5
0987+  C621 7D          	DB #08B8-#083B
0988+  C622 85          	DB #093D-#08B8
0989+  C623 8D          	DB #09CA-#093D
0990+  C624 95          	DB #0A5F-#09CA
0991+  C625 9D          	DB #0AFC-#0A5F
0992+  C626 A8          	DB #0BA4-#0AFC
0993+  C627 B1          	DB #0C55-#0BA4
0994+  C628 BB          	DB #0D10-#0C55
0995+  C629 0C DA       	DB #066D*2/256,(#066D*2)&255
0996+  C62B 62          	DB #06CF-#066D
0997+  C62C 68          	DB #0737-#06CF
0998+  C62D 6D          	DB #07A4-#0737
0999+  C62E 75          	DB #0819-#07A4
1000+  C62F 7B          	DB #0894-#0819
1001+  C630 83          	DB #0917-#0894
1002+  C631 8A          	DB #09A1-#0917
1003+  C632 92          	DB #0A33-#09A1
1004+  C633 9C          	DB #0ACF-#0A33
1005+  C634 A4          	DB #0B73-#0ACF
1006+  C635 AF          	DB #0C22-#0B73
1007+  C636 B8          	DB #0CDA-#0C22
1008+  C637 0E 08       	DB #0704*2/256,(#0704*2)&255
1009+  C639 6A          	DB #076E-#0704
1010+  C63A 72          	DB #07E0-#076E
1011+  C63B 78          	DB #0858-#07E0
1012+  C63C 7E          	DB #08D6-#0858
1013+  C63D 86          	DB #095C-#08D6
1014+  C63E 90          	DB #09EC-#095C
1015+  C63F 96          	DB #0A82-#09EC
1016+  C640 A0          	DB #0B22-#0A82
1017+  C641 AA          	DB #0BCC-#0B22
1018+  C642 B4          	DB #0C80-#0BCC
1019+  C643 BE          	DB #0D3E-#0C80
1020+  C644 0F C0       	DB #07E0*2/256,(#07E0*2)&255
1021+  C646 78          	DB #0858-#07E0
1022+  C647 88          	DB #08E0-#0858
1023+  C648 80          	DB #0960-#08E0
1024+  C649 90          	DB #09F0-#0960
1025+  C64A 98          	DB #0A88-#09F0
1026+  C64B A0          	DB #0B28-#0A88
1027+  C64C B0          	DB #0BD8-#0B28
1028+  C64D A8          	DB #0C80-#0BD8
1029+  C64E E0          	DB #0D60-#0C80
1030+  C64F B0          	DB #0E10-#0D60
1031+  C650 E8          	DB #0EF8-#0E10
1032+  C651             
1033+  C651             ;vars from here can be stripped
1034+  C651             ;you can move VARS to any other address
1035+  C651             
1036+  C651             VARS
1037+  C651             
1038+  C651             ;ChannelsVars
1039+  C651             	STRUCT	CHP
1040+  C651~            ;reset group
1041+  C651~            PsInOr	DB 0
1042+  C651~            PsInSm	DB 0
1043+  C651~            CrAmSl	DB 0
1044+  C651~            CrNsSl	DB 0
1045+  C651~            CrEnSl	DB 0
1046+  C651~            TSlCnt	DB 0
1047+  C651~            CrTnSl	DW 0
1048+  C651~            TnAcc	DW 0
1049+  C651~            COnOff	DB 0
1050+  C651~            ;reset group
1051+  C651~            1052+  C651~            OnOffD	DB 0
1053+  C651~            1054+  C651~            ;IX for PTDECOD here (+12)
1055+  C651~            OffOnD	DB 0
1056+  C651~            OrnPtr	DW 0
1057+  C651~            SamPtr	DW 0
1058+  C651~            NNtSkp	DB 0
1059+  C651~            Note	DB 0
1060+  C651~            SlToNt	DB 0
1061+  C651~            Env_En	DB 0
1062+  C651~            Flags	DB 0
1063+  C651~             ;Enabled - 0,SimpleGliss - 2
1064+  C651~            TnSlDl	DB 0
1065+  C651~            TSlStp	DW 0
1066+  C651~            TnDelt	DW 0
1067+  C651~            NtSkCn	DB 0
1068+  C651~            Volume	DB 0
1069+  C651             	ENDS
1070+  C651             
1071+  C651 00          ChanA	DS CHP
1072+  C66E 00          ChanB	DS CHP
1073+  C68B 00          ChanC	DS CHP
1074+  C6A8             
1075+  C6A8             ;GlobalVars
1076+  C6A8 00          DelyCnt	DB 0
1077+  C6A9 00 00       CurESld	DW 0
1078+  C6AB 00          CurEDel	DB 0
1079+  C6AC             Ns_Base_AddToNs
1080+  C6AC 00          Ns_Base	DB 0
1081+  C6AD 00          AddToNs	DB 0
1082+  C6AE             
1083+  C6AE             AYREGS
1084+  C6AE             
1085+  C6AE 00          VT_	DS 256 ;CreatedVolumeTableAddress
1086+  C7AE             
1087+  C7AE             EnvBase	EQU VT_+14
1088+  C7AE             
1089+  C7AE             T1_	EQU VT_+16 ;Tone tables data depacked here
1090+  C7AE             
1091+  C7AE             T_OLD_1	EQU T1_
1092+  C7AE             T_OLD_2	EQU T_OLD_1+24
1093+  C7AE             T_OLD_3	EQU T_OLD_2+24
1094+  C7AE             T_OLD_0	EQU T_OLD_3+2
1095+  C7AE             T_NEW_0	EQU T_OLD_0
1096+  C7AE             T_NEW_1	EQU T_OLD_1
1097+  C7AE             T_NEW_2	EQU T_NEW_0+24
1098+  C7AE             T_NEW_3	EQU T_OLD_3
1099+  C7AE             
1100+  C7AE 00          NT_	DS 192 ;CreatedNoteTableAddress
1101+  C86E             
1102+  C86E             ;local var
1103+  C86E             Ampl	EQU AYREGS+AmplC
1104+  C86E             
1105+  C86E             VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1106+  C86E             
1107+  C86E             VARSEND EQU $
1108+  C86E             
1109+  C86E             MDLADDR EQU $
1110+  C86E             
1111+  C86E             ;Release 0 steps:
1112+  C86E             ;11.Sep.2004 - Note tables creator
1113+  C86E             ;12.Sep.2004 - Volume tables creator; INIT subroutine
1114+  C86E             ;13.Sep.2004 - Play counters, position counters
1115+  C86E             ;14.Sep.2004 - Patterns decoder subroutine
1116+  C86E             ;15.Sep.2004 - Resting (no code)
1117+  C86E             ;16.Sep.2004 - CHREGS subroutine; global debugging; 1st stable
1118+  C86E             ;version was born
1119+  C86E             ;17.Sep.2004 - Debugging and optimization. First release!
1120+  C86E             ;Release 1 steps:
1121+  C86E             ;20.Sep.2004 - local vars moved to code (selfmodified code
1122+  C86E             ;smaller and faster)
1123+  C86E             ;22.Sep.2004 - added mute sound entry at START+8; position
1124+  C86E             ;pointer moved to START+11; added setup and status byte at
1125+  C86E             ;START+10 noloop mode and loop passed flags added
1126+  C86E             ;Release 2 steps:
1127+  C86E             ;28.Sep.2004 - Optimization: code around CHREGS's volume and
1128+  C86E             ;vibrato faster now; zeroing PD_RES through stack; Ton and Ampl
1129+  C86E             ;moved from channel vars to global ones; first position selector
1130+  C86E             ;removed from INIT; optimization for packers(Ivan Roshin method)
1131+  C86E             ;Release 3 steps:
1132+  C86E             ;2.Oct.2004 - optimization in INIT and PD_LOOP (thanks to Ivan
1133+  C86E             ;Roshin)
1134+  C86E             ;4.Oct.2004 - load delay from (hl) in INIT (2 bytes shorter)
1135+  C86E             ;5.Oct.2004 - optimization in PD_LOOP (->PD_LP2)
1136+  C86E             ;7.Oct.2004 - swaping some commands for better packing
1137+  C86E             ;Release 4 steps:
1138+  C86E             ;9.Oct.2004 - optimization around LD HL,SPCCOMS (thanks to Ivan
1139+  C86E             ;Roshin); in PTDECOD swapped BC and DE to optimize C_PORTM;
1140+  C86E             ;removed sam and orn len and loop channel vars; CHREGS totally
1141+  C86E             ;optimized
1142+  C86E             ;Release 5 steps:
1143+  C86E             ;11.Oct.2004 - PD_OrSm and C_PORTM optimized; Ivan Roshin's
1144+  C86E             ;volume tables creator algorithm (51 bytes shorter than mine)
1145+  C86E             ;12.Oct.2004 - Ivan Roshin's note tables creator algorithm (74
1146+  C86E             ;bytes shorter than mine)
1147+  C86E             ;Release 6 steps:
1148+  C86E             ;14.Oct.2004 - loop and next position calculations moved to INIT
1149+  C86E             ;15.Oct.2004 - AdInPt moved to code
1150+  C86E             ;19.Oct.2004 - Env_Del moved to code
1151+  C86E             ;20.Oct.2004 - Version PUSH and POP (1 byte shorter, thanks to
1152+  C86E             ;Ivan Roshin)
1153+  C86E             ;22.Oct.2004 - Env_En moved from Flags' bit to byte (shorter and
1154+  C86E             ;faster code)
1155+  C86E             ;25.Oct.2004 - SETENV optimized
1156+  C86E             ;29.Oct.2004 - Optimized around AddToEn (SBC A,A, thanks to Ivan
1157+  C86E             ;Roshin)
1158+  C86E             ;3.Nov.2004 - Note tables data was compressed; with depacker it
1159+  C86E             ;is 9 bytes shorter than uncompressed (thanks to Ivan Roshin)
1160+  C86E             ;4.Nov.2004 - default sample and ornament both are fixed now
1161+  C86E             ;and placed into code block (6 bytes shorter)
1162+  C86E             ;7.Nov.2004 - LD A,(Ns_Base):LD L,A changed to LD HL,(Ns_Base)
1163+  C86E             ;(thanks to Dima Bystrov)
1164+  C86E             ;9.Nov.2004 - Ns_Base and AddToNs are merged to Ns_Base_AddToNs;
1165+  C86E             ;LD A,255 changed to DEC A (at start of PLAY); added ROUT_A0
1166+  C86E             ;12.Nov.2004 - NtSkCn&Volume are merged (8 bytes smaller init);
1167+  C86E             ;LD BC,T1_ changed to PUSH DE...POP BC in note table creator
1168+  C86E             ;19.Dec.2004 - NT_DATA reorganized (6 bytes shorter, thanks to
1169+  C86E             ;Ivan Roshin); C_PORTM and C_GLISS are merged via SET_STP (48
1170+  C86E             ;tacts slower, but 8 bytes smaller, thanks to Ivan Roshin)
1171+  C86E             ;Release 7 steps:
1172+  C86E             ;29.Apr.2007 - SjAsm adaptation; new 1.xx and 2.xx
1173+  C86E             ;interpretation for PT 3.7+.
1174+  C86E             
1175+  C86E             ;Tests in IMMATION TESTER V1.0 by Andy Man/POS (thanks to
1176+  C86E             ;Himik's ZxZ for help):
1177+  C86E             ;Module name/author	Min tacts	Max tacts	Average
1178+  C86E             ;Spleen/Nik-O		1720		9256		5500
1179+  C86E             ;Chuta/Miguel		1720		9496		5500
1180+  C86E             ;Zhara/Macros		4536		8744		5500
1181+  C86E             
1182+  C86E             ;Size:
1183+  C86E             ;Code block #651 bytes
1184+  C86E             ;Variables #21D bytes (can be stripped)
1185+  C86E             ;Size in RAM #651+#21D=#86E (2158) bytes
1186+  C86E             
1187+  C86E             ;Notes:
1188+  C86E             ;Pro Tracker 3.4r can not be detected by header, so PT3.4r tone
1189+  C86E             ;tables really used only for modules of 3.3 and older versions.
1190+  C86E             
1191+  C86E             	endmodule
0586   C86E             MusicModule: 
0587   C86E                             incbin "music\mus1.pt3"
0588   F1D8             PlayerEnd: 
0589   F1D8                             savebin "assets\music.bin",PlayerStart,PlayerEnd-PlayerStart
0590   F1D8                             savebin "FBIRD.EXE",start_addr,code_end-start_addr
